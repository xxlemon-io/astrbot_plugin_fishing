# 📦 更新记录

#### v2.4.0 (骰宝游戏全面重构 + 用户昵称系统 + 管理员鱼池管理)

- **🎲 骰宝游戏全面重构**：完全重写骰宝游戏系统，带来全新的游戏体验
  - 新增独立服务层（SicboService），提供更稳定的游戏逻辑
  - 图片化UI界面，美观直观的游戏体验
  - 多会话游戏支持，不同群聊可同时进行游戏
  - 倒计时系统，可配置的倒计时时间（默认60秒）
  - 丰富的下注类型：大小、单双、豹子、指定点数、总点数等
  - 完整的赔率表系统，支持多种赔率配置
  - 图片/文本双模式支持，管理员可切换消息模式
  - 实时游戏状态查看和下注情况查询
  - 管理员控制功能：强制结算、倒计时设置、模式切换
- **👤 用户昵称更改功能**：新增用户可自行更改昵称的功能
  - 支持 `/更新昵称 [新昵称]` 命令，用户可随时更改游戏昵称
  - 昵称验证机制：长度限制（最多32字符）、格式检查
  - 支持中文、英文、数字和常用符号
  - 友好的提示信息，显示旧昵称和新昵称对比
- **🎣 手动重置鱼池功能**：新增管理员手动重置所有钓鱼区域稀有鱼配额的功能
  - 管理员可使用 `/补充鱼池` 命令重置所有区域的稀有鱼配额
  - 智能识别有配额的区域，只重置需要重置的区域
  - 详细的重置报告，显示每个区域的配额信息
  - 方便管理员在特殊情况下快速补充鱼池资源

*感谢 [@Akiyo-dayo](https://github.com/Akiyo-dayo) 的贡献 ([#90](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/90))*

#### v2.3.13 (稀有鱼配额自动重置 + 钓鱼道具效果增强)

- **🔄 稀有鱼每日配额自动重置**：新增自动重置机制，确保稀有鱼配额每日准时刷新
  - 在自动钓鱼任务启动时自动检查并重置所有区域的稀有鱼配额
  - 使用快速路径检查优化性能，避免不必要的锁竞争
  - 添加锁机制防止并发执行，确保重置操作的线程安全
  - 提高系统效率，减少代码重复
- **🎣 钓鱼道具效果增强**：优化便携声纳等钓鱼道具的使用体验
  - 重构 `ResetFishingCooldownEffect`，支持立即执行钓鱼操作
  - 改进单次和批量使用的处理逻辑，提供更详细的结果反馈
  - 优化道具描述，使功能说明更清晰易懂
  - 增强错误处理机制，提升用户体验

#### v2.3.12 (DingTalk平台At逻辑适配)

- **🔧 修复DingTalk平台At逻辑**：在处理At列表时排除机器人自身ID，确保正确识别目标用户

*感谢 [@k1ngr4m](https://github.com/k1ngr4m) 的贡献 ([#87](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/87))*

#### v2.3.11 (市场上架外键约束修复 + 税收线程管理优化)

- **🔧 修复市场上架外键约束错误**：修复用户上架鱼竿/饰品时出现"FOREIGN KEY constraint failed"错误的问题
- **🛡️ 增强MARKET用户创建机制**：在转移装备所有权之前自动检查并创建MARKET系统用户，确保外键约束满足
- **⚡ 提升系统健壮性**：即使MarketService初始化时MARKET用户创建失败，系统也能在需要时自动创建
- **🧵 修复税收线程管理Bug**：插件卸载时正确停止税收线程，防止重复启动导致的多个税收线程并发问题
  
*感谢 [@XiGuang](https://github.com/XiGuang) 的贡献 ([#84](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/84))*

#### v2.3.10 (市场耐久度保留机制)

- **🔧 修复装备耐久度重置Bug**：修复鱼竿/饰品上架市场后，购买或下架时耐久度恢复初始值且ID变化的问题
- **🎯 实现所有权转移机制**：上架时不再删除装备实例，购买/下架时直接转移实例所有权，完整保留耐久度、精炼等级、实例ID等所有属性

#### v2.3.9 (多平台User ID兼容性修复)

- **🔧 修复多平台兼容性**：移除错误的 `int(user_id)` 强制转换
- 数据库和模型层已正确使用TEXT/str类型，此次仅修复业务逻辑层的两处遗留问题

#### v2.3.8 (高品质鱼类市场Bug修复)

- **🐟 修复高品质鱼类市场购买Bug**：修复了高品质鱼类上架后无法购买的问题

#### v2.3.7 (市场购买Bug修复 + 电鱼天罚系统优化 + 每日税收系统重构 + 转账手续费系统)

- **🚨 税收系统重构**：实现逐用户检查机制，解决税收遗漏和重复扣税问题
- **💸 转账手续费系统**：新增转账税收功能，完善经济系统
- **🐛 修复市场购买Bug**：修复了玩家购买自己上架物品导致金币增加的严重漏洞
- **🛡️ 增强交易安全**：新增买家卖家身份检查，禁止玩家购买自己的商品
- **⚡ 优化电鱼天罚系统**：修复天罚等级判断不随配置调整的问题，现在基于相对比例动态判断
- **🔧 改进天罚显示**：天罚等级现在正确反映相对惩罚程度，而不是使用固定阈值

#### v2.3.6 (背包性能优化 + 智能过滤系统)

- **⚡ 物品过多性能优化**：解决背包物品过多导致的超时问题
- **🎯 智能过滤机制**：装备超过30个时自动过滤，仅显示5星以上装备（最多100项）
- **📊 多命令支持**：`/背包`、`/鱼竿`、`/饰品` 命令均支持智能过滤
- **💡 友好提示系统**：提供详细的过滤统计、清理建议和操作指引
- **🛡️ 超时保护**：添加超时机制，失败时返回简化版图片及建议
- **📈 动态统计显示**：实时显示"已显示数量/总数量"，让用户了解实际情况

#### v2.3.5 (交易所自定义更新时间功能)

- **⏰ 自定义价格更新时间**：新增 `update_timing` 配置项，可自定义交易所每日价格更新的时间点
- **📊 动态显示**：交易所帮助信息自动显示实际配置的更新时间

*感谢 [@XiGuang](https://github.com/XiGuang) 的贡献 ([#75](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/75))*

#### v2.3.5 (交易所系统全面优化 + 商店系统品质支持 + 多次十连抽卡功能 + 转账功能)

- **💰 用户转账功能**：新增用户间金币转账功能，支持@用户和用户ID两种方式
- **🛡️ 转账安全机制**：包含余额检查、用户存在性验证、防自转账等安全措施
- **📈 价格历史查看**：新增价格历史曲线功能，支持Sparkline可视化图表
- **📊 市场分析工具**：新增智能市场分析，包含均线、波动率、RSI指标和趋势建议
- **🔍 灵活查询**：支持单商品或全市场查询，可自定义时间窗口（1-30天）
- **💡 投资辅助**：提供基于技术指标的投资建议，帮助玩家做出更明智的交易决策
- **🔧 价格获取逻辑优化**：修复交易所清仓和卖出时的价格获取问题，优先使用今日价格，无则回退到昨日价格
- **⏰ 时间窗口机制**：新增价格更新时间窗口控制，避免重复更新，确保价格数据一致性
- **📊 历史数据修复**：修复价格历史查询中的时间对齐问题，确保跨日价格数据连续性
- **🛡️ 错误处理增强**：改进价格更新失败时的回退机制，提高系统稳定性
- **🔄 批次时间统一**：确保同批次价格更新的时间戳一致性，避免时间混乱
- **🛒 商店品质支持**：商店系统现在完全支持鱼类品质系统，购买奖励自动放入水族箱
- **🐠 智能资源扣除**：优化商店购买时的资源扣除逻辑，支持按品质扣除鱼类成本
- **⚖️ 成本合并优化**：改进商店成本合并算法，正确处理带品质的鱼类成本
- **🎰 多次十连抽卡功能**：新增多次十连抽卡功能，支持 `/十连 [卡池ID] [次数]` 命令
- **📊 合并统计优化**：多次十连自动合并统计结果，包含消耗统计、1-10星稀有度分布、物品数量统计和金币总计
- **🛡️ 安全限制**：最多支持100次十连，防止单次操作过多
- **💰 市场手续费政策调整**：市场下架商品时不再返还上架手续费，防止玩家通过频繁上架下架规避每日税收系统，维护游戏经济平衡

*感谢 [@XiGuang](https://github.com/XiGuang) 的贡献 ([#73](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/73), [#74](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/74)) 和 [@WWWA7](https://github.com/WWWA7) 的贡献 ([#71](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/71))*

#### v2.3.4 (商店系统扣除修复)

- **🛒 修复水族箱鱼类扣除Bug**：商店购买时正确扣除水族箱中的鱼类成本
- **🔧 优化智能扣除逻辑**：支持按品质扣除鱼类，优先鱼塘后水族箱

*感谢 [@WWWA7](https://github.com/WWWA7) 的贡献 ([#70](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/70))*

#### v2.3.3 (算法优化与保护增强)

- **🎣 修复钓鱼算法Bug**：采用标准加权随机算法，修复旧算法的边界问题和异常行为
- **🔒 批量出售保护**：出售鱼竿/饰品时自动跳过锁定装备，消息显示实际出售数量

*感谢 [@WWWA7](https://github.com/WWWA7) 的贡献 ([#69](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/69))*

#### v2.3.2 (电鱼功能平衡优化与配置重构)

- **🌩️ 天罚机制**：失败惩罚改为扣除当前金币的0-最大天罚比例（正态分布，可配置）
  - 天罚等级基于相对惩罚强度判断（0-20%、20-50%、50-80%、80-100%）
  - 正态分布特性：约68%的惩罚在均值±标准差范围内，约95%在0到最大值之间
- **📊 分段式收益**：根据成功幸运度分为大成功、普通成功、小成功三档（15%-20%、10%-15%、5%-10%）
- **🗂️ 配置文件重构**：将 `_conf_schema.json` 重构为层次化结构，按功能模块分类配置项

#### v2.3.1 (紧急修复：税收重复征收问题)

- **🚨 修复税收重复扣除BUG**：解决了每日资产税在同一天被重复扣除的问题
- **🔒 税收线程安全加固**：添加双重锁机制（线程启动锁 + 税收执行锁），防止并发竞态条件

#### v2.3.0 (稀有度加成修复 + 品质系统重构)

- **🔧 修复稀有度加成BUG**：稀有度加成（rare_chance）现在正确影响4-5星鱼的概率，6+星鱼保持纯运气机制
- **✨ 品质系统重构**：引入二元品质系统，鱼类分为普通品质和高品质两种堆叠，高品质鱼按双倍价值出售
- **⚙️ 品质触发概率可配置**：管理员可通过配置文件调整高品质鱼的最大触发概率（默认35%）
- **📊 对数压缩公式**：使用数学公式处理装备乘法累积，避免高品质鱼过于常见
- **🎯 游戏平衡优化**：保持高品质鱼的稀有性，同时让装备搭配有实际意义

#### v2.2.6 (排行榜UI优化)

- **🎨 排行榜布局优化**：采用三列固定布局，金币居中显示，装备信息固定右对齐
- **📊 重量格式化增强**：大数值重量使用K、M、B等单位显示，与其他数值格式保持一致

#### v2.2.5 (紧急修复：税收重复征收BUG)

- **🚨 修复税收重复执行BUG**：插件重启时不再重复扣税，添加数据库检查确保每日仅执行一次
- **🔧 优化税收线程逻辑**：`is_tax=False` 时不启动线程，增强日志输出（征税用户数、总金币数）

#### v2.2.4 (交易所卖出Bug修复)

- **🐛 修复交易所卖出命令错误**：修复了 `/交易所 卖出` 命令出现 `name 'total_value' is not defined` 错误的问题

#### v2.2.3 (命运轮盘配置修复 + 帮助图像更新 + 税收系统重构)

- **🐛 修复命运轮盘次数显示不匹配**：修复/状态命令中命运轮盘次数与配置不同步的问题
- **🔧 配置同步优化**：确保所有命运轮盘次数相关显示都从配置文件读取
- **🔧 修复game_config配置缺失**：全面修复main.py中缺失的配置项传递
- **🚨 重构独立税收线程**：税收现在完全独立于自动钓鱼功能，保证每日准时执行
- **🖼️ 补全钓鱼帮助图像**：更新 `/钓鱼帮助` 命令的图像输出，补充了自2.2.0版本以来的新增命令
- **🎰 新增抽卡玩法展示**：添加命运之轮、骰子游戏等新玩法到帮助图像
- **⚡ 新增电鱼功能展示**：在社交功能区显示电鱼命令说明
- **📈 新增交易所功能展示**：添加完整的大宗商品交易所命令说明
- **🎨 优化帮助布局**：自动计算高度以适应新增命令，保持视觉美观

#### v2.2.2 (商店/兑换系统优化)

- **🔧 优化商店OR条件兑换逻辑**：使用递归回溯算法智能选择支付组合
- **⚡ 批量查询性能优化**：新增批量鱼类库存查询方法，提升性能
- **🐛 修复OR条件资源检查问题**：确保多条件支付的准确性和原子性

*感谢 [@WWWA7](https://github.com/WWWA7) 的贡献 ([#57](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/57))*

#### v2.2.1 (命运轮盘平衡调整)

- **⚖️ 命运轮盘平衡调整**：每日次数限制从5次调整为3次，重新设计为高风险高回报模型
- **🔧 命运轮盘可配置**：每日次数限制现在可通过配置文件调整，默认值为3次
- **🎯 庄家优势保证**：整体House Edge约67%

#### v2.2.0 (新游戏玩法与功能优化)

- **⚡ 电鱼功能**：新增电鱼玩法，可以电击其他玩家的鱼塘，有成功率机制和天罚惩罚，收益分为大中小三个档次
- **🎲 猜大小游戏**：新增骰宝游戏，支持大小、单双、点数等多种下注方式
- **🎰 命运之轮**：新增命运之轮游戏，高风险高回报的轮盘游戏，支持多轮挑战
- **📦 批量稀有度出售**：支持按稀有度批量出售鱼类，提升管理效率
- **⏰ 每日重置时间配置**：可配置每日重置时间点（0-23小时），灵活管理游戏节奏
- **💣 擦弹炸弹系统优化**：优化擦弹炸弹功能，增加更多策略性和趣味性
- **🔧 系统优化**：改进错误处理、代码可读性和用户体验
- **📊 数据统计增强**：优化总价值计算和显示功能

*感谢 [@WWWA7](https://github.com/WWWA7) 的贡献 ([#47](https://github.com/xxlemon-io/astrbot_plugin_fishing/pull/47))*

#### v2.1.0 (交易所系统)

- **💼 全新交易所系统**：支持大宗商品（鱼干、鱼油、鱼卵）的买卖交易
- **📈 动态价格机制**：商品价格每日波动，基于趋势、随机性和特殊事件
- **📊 详细盈亏分析**：显示总成本、总收入、净盈亏、盈利率，帮助用户了解投资表现
- **📦 商品腐败系统**：商品有1-3天腐败时间，过期自动清理，增加策略性
- **⚖️ 容量管理**：总持仓上限1000份，上架商品仍占用容量，增加投资决策难度
- **💰 税收系统**：交易收取5%税费，增加经济平衡性
- **🏪 市场集成**：大宗商品可上架到玩家市场，支持匿名交易
- **🔧 统一短码**：使用C开头的短码（如C1A）进行商品操作
- **📋 便捷命令**：支持按商品名称卖出、清仓、持仓查看等便捷操作
- **⚙️ 可配置参数**：容量上限、税率等参数可通过配置文件调整

#### v2.0.9 (沙漏预测系统Bug修复)

- **🔧 修复沙漏预测Bug**：修复了沙漏预测到高倍率时必定获得高倍率奖励的严重bug
- **⚖️ 恢复预测本质**：预测功能现在只提前告知结果，不再影响实际擦弹概率分布
- **🎯 保持游戏平衡**：无论预测结果如何，实际擦弹都按照原始概率进行，确保游戏公平性
- **🙏 致歉说明**：对于上个版本中沙漏预测功能影响游戏平衡的问题，深表歉意，现已完全修复

#### v2.0.8 (沙漏预测系统平衡性调整)

- **🔮 沙漏预测削弱**：将预测准确率从100%降低到33.3%，增加游戏平衡性
- **❌ 占卜失败机制**：新增33%的占卜失败概率，失败时无法获得任何预测结果
- **🎲 错误预测优化**：33.4%概率获得错误预测，增加策略性和不确定性

#### v2.0.7 (性能优化与命令重构)

- **⚡ 图像生成优化**：添加超时处理，使用numpy加速渐变生成，优化文本处理
- **🛒 统一出售命令**：引入 `/出售` 命令，支持基于短码的装备出售

#### v2.0.0 (系统重构大规模！ - 重大更新)

- **🏪 全新商店系统**：重构为多商店类型系统，支持普通商店、高级商店、限时商店
- **🛍️ 复杂商品机制**：支持多种成本类型（金币、高级货币、鱼竿、饰品、道具）和奖励机制
- **🔒 线程安全优化**：新增DatabaseConnectionManager，提供线程安全的数据库连接管理
- **🎣 商店商品扩展**：支持鱼竿和饰品作为商店商品，丰富商品类型
- **🌐 Web管理增强**：新增商店管理界面，支持商店创建、商品管理、库存控制
- **⏰ 时间控制功能**：支持商店营业时间、每日营业时间、限时商品等时间控制
- **🚫 限购机制**：支持每人限购、每日限购等购买限制
- **🔗 成本分组系统**：支持复杂的成本组合逻辑（AND/OR关系）
- **🏷️ 显示代码系统**：鱼竿和饰品支持Base36编码的短代码显示，便于用户识别和管理
  - 短代码显示：装备实例现在支持Base36编码的短代码显示
  - 便于识别：用户可以通过短代码快速识别和管理装备
  - 自动生成：系统自动为所有装备实例生成唯一的显示代码
- **✨ 稀有度颜色扩展**：新增6-10星稀有度颜色映射，支持更高稀有度显示
- **🎰 擦弹功能优化**：改进消息格式，添加抑制通知，提升用户体验
- **✂️ 消息截断保护**：防止消息过长导致显示问题，自动截断超长内容
- **🎁 批量道具发放**：管理员可给所有用户批量发放指定道具
- **🐟 鱼类市场支持**：支持鱼类上架和交易，丰富市场商品类型
- **👤 匿名上架功能**：支持匿名上架商品，保护卖家隐私
- **👀 偷看鱼塘功能**：可以查看其他用户的鱼塘和鱼类收藏
- **🔧 统一物品操作**：所有物品使用统一的短码系统进行操作
- **📦 数据迁移**：平滑升级，保持数据兼容性

#### 短码系统说明（2.0版本）

- **短码格式**：所有物品现在使用Base36编码的短码显示
  - `R`开头：鱼竿（如 R2N9C）
  - `A`开头：饰品（如 A7K3Q）
  - `D`开头：道具（如 D1）
  - `B`开头：鱼饵（如 B2）
  - `F`开头：鱼类（如 F3）
  - `C`开头：大宗商品（如 C1A）
  - `M`开头：市场商品（如 M1A2B）

- **统一命令**：所有物品操作现在使用统一的短码格式
  - `/使用 [短码]` - 使用任何类型的物品
  - `/精炼 [短码]` - 精炼鱼竿或饰品
  - `/锁定 [短码]` - 锁定任何装备
  - `/上架 [短码] [价格]` - 上架任何物品到市场

#### 显示代码示例
```
鱼竿: 普通鱼竿 (ID: R2N9C) [3★] 精炼+5
饰品: 幸运护符 (ID: A7K3Q) [4★] 精炼+3
道具: 金币袋 (ID: D1) x10
鱼类: 金鱼 (ID: F3) x5
大宗商品: 鱼油 (ID: C1A) x10 腐败倒计时: 2天
```

#### v1.7.5 (图鉴系统重构)

- **🖼️ 图鉴图片化**：文本图鉴改为美观图片展示，每页显示20个鱼类
- **🎨 背包风格设计**：渐变背景、圆角设计、用户头像集成
- **⚡ 数据优化**：新增统计表提升性能，自动清理历史数据
- **✨ 视觉效果**：丰富色彩搭配，文本符号增强，布局优化

#### v1.7.4 (打开全部钱袋功能)

- **💰 更新 `/打开全部钱袋` 命令**，提升用户体验

#### v1.7.3 (架构重构)

- **🏗️ 统一命令注册方式**，优化代码结构
- **🔗 新增命令别名**，提升用户体验
- **🔄 保持向后兼容**，不改变游戏逻辑

#### v1.7.2 (反制道具系统)

- **🛡️ 新增破灵符、驱灵香、暗影斗篷等反制道具**
- **⚖️ 平衡海灵守护机制**，增加策略性

#### v1.7.1 (稀有度调整)

- **⭐ 稀有鱼范围调整为4星+**
- **🎯 优化配额系统**，提升游戏平衡性

#### v1.7.0 (精炼系统升级)

- **⚠️ 新增降级失败机制**，三种失败结果
- **🔒 优化锁定装备功能**，修复设计失误
- **📈 调整精炼成功率**，提升挑战性

#### v1.6.9 (扩展稀有度系统)

- **⭐ 移除5星限制**，支持任意星级鱼类
- **🔧 后台支持高星级鱼类管理**

#### v1.6.8 (装备保护功能)

- **🔒 新增装备锁定系统**，防止意外操作
- **💥 新增砸锅卖铁功能**，一键清仓

#### v1.6.7 (安全更新)

- **🔐 后台管理地址改为localhost**，提升安全性

#### v1.6.6 (紧急修复)

- **🐛 修复饰品/鱼竿无限卖出Bug**
- **🔇 修复批量使用道具消息刷屏问题**

#### v1.6.5 (钓鱼区域系统)

- **🎫 智能通行证机制**，自动消耗系统
- **⚙️ 后台管理配置**，用户体验提升

#### v1.6.4 (道具系统)

- **🛡️ 新增守护海灵、时运沙漏道具**
- **🎰 擦弹玩法升级**，御神籤风格占卜

#### v1.6.3 (精炼系统)

- **💰 修复精炼金币提示问题**
- **⚖️ 统一精炼失败机制**
- **🔮 新增精炼护符系统**，保护装备精炼
- **⚡ 管理命令精简**，新增同步道具功能

#### v1.6.2 (市场系统)

- **💵 重构出售定价系统**，支持精炼等级乘数
- **📦 优化批量出售功能**

#### v1.6.1 (代码重构)

- **🤖 AI代码审计重构**，性能优化
- **⚡ 异步改造**，提升高并发性能
- **🛡️ 健壮性增强**，路径管理优化
- **🔒 安全加固**，代码去重

#### v1.4.6 - v.1.6.0

- **💎 扩展了高级货币/钻石/星石功能**
- **🎁 增加了道具系统**，现在你有更多机会偷鱼和擦弹！
- **🎰 新增了每日免费一抽**，签到自动抽取
- **🎒 新增了背包功能**，使用/背包来查看所有物品
- **⚡ 更好的精炼系统**，新增了耐久和毁坏机制。使用/精炼命令来查看新特性
- **📊 新增了后台管理界面CSV批量导入鱼竿和饰品**
- **👥 后台管理功能增加了用户管理功能**
- **🏪 后台管理功能增加了市场管理功能**
- **🔧 补充了管理员命令** `/代理上线` 和 `/代理下线`。
- **🔗 新增了很多命令的别名**
- **🎲 更好的卡池管理系统**，支持高级货币和限时卡池
- **🐛 修复了鱼竿的数量加成没有生效的BUG**。

