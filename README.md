![:astrbot_plugin_fish](https://count.getloli.com/@:astrbot_plugin_fish?theme=capoo-1)

# AstrBot 钓鱼插件

一个功能齐全的钓鱼游戏系统插件，为您的机器人添加有趣的钓鱼休闲游戏。

[![AGPL-3.0 License](https://img.shields.io/badge/License-AGPL--3.0-blue.svg)](https://opensource.org/licenses/AGPL-3.0)
[![Python](https://img.shields.io/badge/Python-3.8+-green.svg)](https://python.org)
[![AstrBot](https://img.shields.io/badge/AstrBot-Plugin-orange.svg)](https://github.com/astrbot/astrbot)

## ✨ 功能特点

- **完整的钓鱼游戏系统**：多种鱼类和稀有度，丰富的钓鱼体验
- **可扩展的稀有度系统**：支持6星及以上的超稀有鱼类，打破传统5星限制
- **智能区域访问控制**：通行证机制，不同区域有不同的进入要求
- **装备精炼系统**：鱼竿、饰品可精炼升级，提升属性加成
- **装备保护系统**：锁定功能保护高级装备，防止意外精炼、卖出、上架
- **道具系统**：丰富的道具效果，包括通行证、护符、增益道具等
- **经济系统**：金币、高级货币双货币体系，市场交易系统
- **抽卡系统**：多种卡池，限时活动，十连保底机制
- **社交功能**：排行榜、偷鱼、成就称号系统
- **后台管理**：Web管理界面，支持数据导入导出，灵活配置游戏参数
- **数据兼容**：支持导入1.4.6版本数据，平滑升级体验

## 🔧 安装方法

1. 将此插件放入 `data/plugins/` 目录。或者安装插件时→从链接安装→本项目地址
2. 重启 AstrBot 或使用插件管理命令加载插件

## 💡 未来计划

如果你有什么想法，欢迎提交issue！期待您天马行空的想法

### 🤝 开发计划

- [x] 分离成就模块，以便于未来拓展
- [ ] 丰富图鉴类命令
- [ ] 将部分输出结果改写成输出图片
- [x] 钓鱼区域功能扩展
- [x] 更多经济系统
- [ ] 重构商店系统
- [x] 扩展背包，增加道具栏
- [x] 装备保护系统（锁定功能）
- [x] 更多社交玩法
 
## 📦 更新记录

#### v1.7.2 (反制海灵守护道具系统)

- **新增反制道具系统**：
  - **破灵符** (4星)：1小时内可以穿透海灵守护进行偷窃
  - **驱灵香** (5星)：使用 `/驱灵 @目标用户` 直接驱散目标的海灵守护效果
  - **暗影斗篷** (3星)：无限时间，但只能反制一次，使用后立即失效

- **海灵守护平衡性调整**：
  - **保持强势**：4小时完全免疫偷窃，可叠加时间
  - **增加反制手段**：提供多种反制道具，增加策略性
  - **成本权衡**：不同稀有度的反制道具满足不同层次玩家需求

#### v1.7.1 (钓鱼稀有度定义更新)

- **稀有鱼定义调整**：
  - **扩展稀有鱼范围**：从5星及以上调整为4星及以上
  - **配额系统优化**：4星鱼类现在也计入稀有鱼配额限制
  - **平衡性提升**：让更多鱼类享受稀有鱼的特殊待遇
  - **向后兼容**：保持现有存档的兼容性

#### v1.7.0 (精炼系统重大升级)

- **精炼失败机制革新**：
  - **三种失败结果**：普通失败、降级失败、毁坏失败
  - **降级机制**：精炼失败时10%概率装备等级-1（新增）
  - **智能概率系统**：根据装备稀有度和精炼等级动态调整失败类型
  - **更平衡的挑战性**：5星以上装备失败率显著提升

- **锁定装备功能优化**：
  - **修复设计失误**：锁定的装备现在可以作为主装备精炼
  - **保护机制**：锁定的装备不能作为精炼材料被消耗
  - **风险保持**：锁定的装备精炼失败时仍会被碎掉
  - **用户体验**：更新了所有相关说明和帮助文本

- **精炼成功率调整**：
  - **5星装备**：6→10级成功率调整为50%、40%、35%、30%、25%
  - **6星装备**：6→10级成功率调整为45%、35%、30%、25%、20%
  - **7星+装备**：保持高挑战性，6→10级为60%、50%、40%、30%、20%

- **帮助系统完善**：
  - 新增详细的失败类型与概率说明
  - 更新精炼帮助文本，包含降级机制说明
  - 优化命令别名，提升用户体验

#### v1.6.9 (扩展稀有度系统)

- **核心升级 - 鱼类稀有度系统扩展**：
  - **打破上限**：移除了鱼类稀有度（星级）的5星限制，现在支持任意正整数星级。
  - **引入超稀有概念**：管理员可通过后台轻松创建6星、7星乃至更高星级的“超稀有”鱼类，为游戏后期和特殊活动提供更大设计空间。
  - **后台全面支持**：Web管理后台的鱼类管理功能已同步更新，支持高星级鱼类的添加、编辑和CSV批量导入。
  - **动态显示**：游戏内外的稀有度显示（★）能够动态适应并正确展示高星级。

#### v1.6.8 (装备保护功能)

- **新增鱼竿和饰品锁定保护系统**：
  - **锁定功能**：玩家可锁定高级装备，防止意外操作
  - **保护范围**：锁定的装备无法被当作精炼材料、卖出、上架到市场
  - **正常使用**：锁定的装备仍可正常装备、卸下和作为主装备精炼
  - **精炼风险**：锁定的装备精炼失败时仍会被碎掉
  - **用户命令**：
    - `/锁定鱼竿 [ID]` - 锁定指定鱼竿
    - `/解锁鱼竿 [ID]` - 解锁指定鱼竿
    - `/锁定饰品 [ID]` - 锁定指定饰品
    - `/解锁饰品 [ID]` - 解锁指定饰品
  - **界面显示**：背包和管理界面显示锁定状态（🔒 已锁定 / 🔓 未锁定）
  - **数据库升级**：自动添加锁定状态字段，向后兼容现有数据
- **新增砸锅卖铁功能**：
  - **一键清仓**：快速出售所有未锁定且未装备的鱼竿、饰品和全部鱼类
  - **智能保护**：自动保留当前装备中的鱼竿和饰品，以及所有锁定的装备
  - **详细反馈**：显示出售物品的详细数量和获得的金币数
  - **用户命令**：
    - `/砸锅卖铁` - 出售所有可出售的物品
    - 别名：`/破产`、`/清仓`、`/一键清空`、`/全部卖出装备`、`/卖光所有`
  - **使用场景**：为擦弹等活动快速筹集资金

#### v1.6.7 (安全更新)

- **后台管理安全加固**：
  - 将后台管理地址从公网IP改为localhost，大幅提升安全性
  - 只有同一局域网内的设备才能访问管理后台，避免外部恶意访问

#### v1.6.6 (紧急修复)

- **修复严重Bug - 饰品/鱼竿无限卖出问题**：
  - 修复了"出售所有饰品"和"出售所有鱼竿"命令的严重逻辑错误
  - 原问题：系统计算所有未装备物品价值但只删除小于5星的物品，导致5星物品被重复计算金币但不会被删除
  - 修复方案：只计算和删除小于5星的物品，确保计算价值与实际删除物品一致
  - 影响范围：`/出售所有饰品`、`/出售所有鱼竿` 命令
- **修复用户体验问题 - 批量使用道具消息刷屏**：
  - 修复了批量使用道具时发送大量重复消息的问题
  - 原问题：使用99个道具会发送99条消息，严重影响用户体验
  - 修复方案：改为发送汇总消息，如"✅ 成功使用了 99 个道具！"
  - 影响范围：`/使用道具 [ID] [数量]` 命令

#### v1.6.5

- **钓鱼区域访问控制系统重构**：
  - **智能通行证机制**：特定钓鱼区域需要持有对应通行证才能进入
  - **自动消耗系统**：切换区域时自动消耗通行证，无需手动使用道具
  - **后台管理**：管理员可通过Web后台灵活配置各区域的通行证要求
  - **成本透明**：所有区域显示钓鱼消耗，帮助用户做出明智选择
- **区域管理增强**：
  - 区域信息显示优化，包含通行证要求和钓鱼成本
  - 支持动态区域ID验证，避免硬编码限制
  - 通行证道具设置为不可消耗，防止误用
- **用户体验提升**：
  - `/钓鱼区域` 命令现在显示每个区域的详细成本和访问要求
  - `/钓鱼` 命令显示当前区域的钓鱼消耗
  - 通行证不足时提供明确的提示信息
  - 区域名称动态获取，确保信息准确性

#### v1.6.4

- **新增道具**：
  - **守护海灵**：使用后4小时内鱼塘免受偷窃。
  - **时运沙漏**：可占卜下一次擦弹的运势。
- **擦弹玩法重大升级**：
  - 占卜结果采用"御神籤"风格，分为「大吉、中吉、吉、小吉、凶、大凶」六档。
  - 占卜结果将**锁定**下一次擦弹的奖励倍率到对应区间，极大增强了策略性。
  - 重置擦弹概率模型，引入了`0.0~0.1`倍（大凶）和`15.0~1000.0`倍（大吉）的极低概率区间，让结果更具戏剧性。
- **机制优化**：
  - `/偷鱼` 指令现在会检查目标用户是否处于「守护海灵」的保护状态下。

#### v1.6.3

- 修复：精炼金币不足提示出现 "None 金币" 的问题，现显示正确所需金币。
- 变更：精炼失败机制统一为"两种失败均消耗材料与金币"：
  - 普通失败：本体保留，但已消耗材料与金币
  - 毁坏失败（高等级概率触发）：消耗材料与金币，并摧毁本体
- 体验：当没有可用的同模板未装备材料时给出明确提示。
- 文档：更新 `/精炼帮助` 文案以反映新失败机制。
- 新增三档精炼护符（不可直接使用，精炼毁坏时自动消耗）：
  - 破厄护符·守（4★）：5星及以下装备，毁坏改为普通失败，本体保留且不降级。
  - 破厄护符·折（4★）：毁坏触发时降1级并保留本体。
  - 天命护符·神佑（5★）：毁坏必改为普通失败，本体保留且不降级。
- 精炼毁坏分支支持自动识别并优先消耗 keep 类护符，其次消耗 downgrade 类护符；若均无则按原逻辑处理。
- 管理命令精简：将"管理员 同步道具"简化为"同步道具"（仍需管理员权限）。
- 帮助图片与命令手册新增"/同步道具"说明。

#### v1.6.2

- 出售定价重构：鱼竿与饰品的系统回收价 = 基础价(按稀有度) × 精炼等级乘数。
- 支持通过配置项 `sell_prices` 精细化控制不同稀有度的基础价与各精炼等级的乘数。
- 批量出售（出售所有鱼竿/饰品）同样按新规则逐件计价，并跳过正在装备的物品。

#### v1.6.1 (AI代码审计重构)

- **代码质量提升**: 根据AI代码审计报告，对插件进行了全面的重构。
- **性能优化**: 修复了多处阻塞事件循环的同步操作，包括文件IO、网络请求和子进程调用，全部改造为异步实现，显著提升插件在高并发场景下的性能和响应速度。
- **健壮性增强**: 修复了潜在的逻辑bug（如图鉴进度计算错误），收紧了异常捕获的范围，避免隐藏潜在错误。
- **路径管理优化**: 将所有硬编码的文件路径（数据库、临时文件、头像缓存）替换为由框架动态生成的数据目录，增强了插件的可移植性和规范性。
- **安全加固**: 移除了后台管理的硬编码默认密钥，避免了安全隐患。
- **代码去重**: 将绘图模块中重复的辅助函数提取到共享的`utils.py`中，提高了代码的可维护性。

#### v1.4.6 - v.1.6.0

- 扩展了高级货币/钻石/星石功能
- 增加了道具系统，现在你有更多机会偷鱼和擦弹！
- 新增了每日免费一抽，签到自动抽取
- 新增了背包功能，使用/背包来查看所有物品
- 更好的精炼系统，新增了耐久和毁坏机制。使用/精炼命令来查看新特性
- 新增了后台管理界面CSV批量导入鱼竿和饰品
- 后台管理功能增加了用户管理功能
- 后台管理功能增加了市场管理功能
- 补充了管理员命令 `/代理上线` 和 `/代理下线`。
- 新增了很多命令的别名
- 更好的卡池管理系统，支持高级货币和限时卡池
- 修复了鱼竿的数量加成没有生效的BUG。

## ✨ 功能特点

- **完整的钓鱼游戏系统**：多种鱼类和稀有度，丰富的钓鱼体验
- **智能区域访问控制**：通行证机制，不同区域有不同的进入要求
- **装备精炼系统**：鱼竿、饰品可精炼升级，提升属性加成
- **装备保护系统**：锁定功能保护高级装备，防止意外精炼、卖出、上架
- **道具系统**：丰富的道具效果，包括通行证、护符、增益道具等
- **经济系统**：金币、高级货币双货币体系，市场交易系统
- **抽卡系统**：多种卡池，限时活动，十连保底机制
- **社交功能**：排行榜、偷鱼、成就称号系统
- **后台管理**：Web管理界面，支持数据导入导出，灵活配置游戏参数
- **数据兼容**：支持导入1.4.6版本数据，平滑升级体验

![image](https://github.com/user-attachments/assets/4dd1a179-967f-4cb9-82a5-ca3754b80bb0)
![image](https://github.com/user-attachments/assets/c80550e6-86a2-4373-b593-a7e2a8d0ab6b)
![image](https://github.com/user-attachments/assets/b7fd24bc-c0fe-4cee-9431-41b38af665e6)

## 🎣 钓鱼游戏命令手册 🎣

提示：命令中的 [ID] 表示必填参数，<> 表示可选参数。

### 🎣 基础与核心玩法

| 命令 | 描述 |
|---|---|
| `/注册` | 注册新用户 |
| `/钓鱼` | 进行一次钓鱼 |
| `/签到` | 每日签到 |
| `/自动钓鱼` | 开启/关闭自动钓鱼 |
| `/钓鱼区域 [ID]` | 查看或切换钓鱼区域（需要通行证的区域会自动消耗） |
| `/钓鱼记录` | 查看最近钓鱼记录 |
| `/钓鱼帮助` | 查看帮助菜单 |

### 🎒 背包与资产管理

| 命令 | 描述 |
|---|---|
| `/状态` | 查看个人详细状态 |
| `/背包` | 查看我的所有物品 |
| `/鱼塘` | 查看鱼塘中的所有鱼 |
| `/鱼塘容量` | 查看当前鱼塘容量 |
| `/升级鱼塘` | 升级鱼塘容量 |
| `/鱼竿` | 查看我的鱼竿 |
| `/鱼饵` | 查看我的鱼饵 |
| `/饰品` | 查看我的饰品 |
| `/道具` | 查看我的道具 |
| `/使用道具 [ID]` | 使用指定ID的道具（部分道具不可直接使用） |
| `/卖道具 [ID] [数量]` | 出售指定ID和数量的道具 |
| `/使用鱼竿 [ID]` | 装备指定ID鱼竿 |
| `/使用鱼饵 [ID]` | 使用指定ID鱼饵 |
| `/使用饰品 [ID]` | 装备指定ID饰品 |
| `/精炼鱼竿 [ID]` | 精炼指定ID鱼竿 |
| `/精炼饰品 [ID]` | 精炼指定ID饰品 |
| `/精炼帮助` | 查看精炼系统详细说明 |
| `/锁定鱼竿 [ID]` | 锁定指定ID鱼竿，防止被精炼、卖出、上架 |
| `/解锁鱼竿 [ID]` | 解锁指定ID鱼竿，允许正常操作 |
| `/锁定饰品 [ID]` | 锁定指定ID饰品，防止被精炼、卖出、上架 |
| `/解锁饰品 [ID]` | 解锁指定ID饰品，允许正常操作 |
| `/金币` | 查看金币余额 |
| `/高级货币` | 查看高级货币余额 |

### 🛒 商店与市场

| 命令 | 描述 |
|---|---|
| `/全部卖出` | 一键卖出鱼塘所有鱼 |
| `/保留卖出` | 卖出所有鱼但每种保留一条 |
| `/砸锅卖铁` | 出售所有未锁定且未装备的鱼竿、饰品和全部鱼类 |
| `/出售稀有度 [1-5]` | 卖出指定稀有度的鱼 |
| `/出售鱼竿 [ID]` | 出售指定ID鱼竿（按稀有度×精炼等级计价） |
| `/出售所有鱼竿` | 一键出售所有(非在用/非保护)鱼竿（逐件按新规则计价） |
| `/出售饰品 [ID]` | 出售指定ID饰品（按稀有度×精炼等级计价） |
| `/出售所有饰品` | 一键出售所有(非在用/非保护)饰品（逐件按新规则计价） |
| `/商店` | 查看官方商店 |
| `/购买鱼竿 [ID]` | 从商店购买鱼竿 |
| `/购买鱼饵 [ID]` | 从商店购买鱼饵 |
| `/市场` | 查看玩家交易市场 |
| `/上架鱼竿 [ID] [价格]` | 将鱼竿上架市场 |
| `/上架饰品 [ID] [价格]` | 将饰品上架市场 |
| `/上架道具 [ID] [价格]` | 将道具上架市场 |
| `/购买 [ID]` | 从市场购买商品 |
| `/我的上架` | 查看我上架的商品 |
| `/下架 [ID]` | 下架我的商品 |

### 💰 出售定价与配置（鱼竿/饰品）

- 系统回收价计算：`售价 = 基础价(按稀有度) × 精炼等级乘数`
- 适用范围：`/出售鱼竿`、`/出售饰品`、`/出售所有鱼竿`、`/出售所有饰品`
- 批量出售会跳过正在装备的物品

配置示例（位于插件运行时装配的 `game_config` 中）：

```json
{
  "sell_prices": {
    "rod": { "1": 100, "2": 500, "3": 2000, "4": 5000, "5": 10000 },
    "accessory": { "1": 100, "2": 500, "3": 2000, "4": 5000, "5": 10000 },
    "refine_multiplier": {
      "1": 1.0, "2": 1.6, "3": 3.0, "4": 6.0, "5": 12.0,
      "6": 25.0, "7": 55.0, "8": 125.0, "9": 280.0, "10": 660.0
    }
  }
}
```

- 你可以按需调整不同稀有度的基础价，或调整各精炼等级的乘数曲线（当前默认为递增、近指数型曲线，鼓励高精炼装备的投资回报）。
- 市场玩家间交易价格不受上述配置限制，由卖家自定。

### 🎫 通行证机制说明

- **智能通行证系统**：特定钓鱼区域需要持有对应通行证才能进入
- **自动消耗机制**：使用 `/钓鱼区域 [ID]` 切换区域时，如果该区域需要通行证，系统会自动消耗一个通行证
- **通行证道具**：通行证道具设置为不可直接使用，防止误操作消耗
- **区域配置**：管理员可通过Web后台或命令设置各区域的通行证要求
- **成本透明**：每个区域都会显示钓鱼消耗和通行证要求，帮助用户做出明智选择

### 🎰 抽卡与概率玩法

| 命令 | 描述 |
|---|---|
| `/抽卡 [卡池ID]` | 进行单次抽卡 |
| `/十连 [卡池ID]` | 进行十连抽卡 |
| `/查看卡池 [ID]` | 查看卡池详情 |
| `/抽卡记录` | 查看我的抽卡记录 |
| `/擦弹 [金额]` | 进行擦弹游戏 (可填allin/halfin) |
| `/擦弹记录` | 查看我的擦弹记录 |

### 👥 社交功能

| 命令 | 描述 |
|---|---|
| `/排行榜` | 查看金币排行榜 |
| `/偷鱼 [@用户]` | 偷取指定用户的一条鱼 |
| `/查看称号` | 查看我拥有的称号 |
| `/使用称号 [ID]` | 装备指定ID称号 |
| `/查看成就` | 查看我的成就进度 |
| `/税收记录` | 查看我的税收记录 |
| `/鱼类图鉴` | 查看已解锁的鱼类图鉴 |

### ⚙️ 管理后台（管理员）

| 命令 | 描述 |
|---|---|
| `/修改金币 [用户ID] [数量]` | 修改用户金币 |
| `/奖励金币 [用户ID] [数量]` | 奖励用户金币 |
| `/扣除金币 [用户ID] [数量]` | 扣除用户金币 |
| `/修改高级货币 [用户ID] [数量]` | 修改高级货币 |
| `/奖励高级货币 [用户ID] [数量]` | 奖励高级货币 |
| `/扣除高级货币 [用户ID] [数量]` | 扣除高级货币 |
| `/全体奖励金币 [数量]` | 给所有用户发放金币 |
| `/全体奖励高级货币 [数量]` | 给所有用户发放高级货币 |
| `/全体扣除金币 [数量]` | 从所有用户扣除金币 |
| `/全体扣除高级货币 [数量]` | 从所有用户扣除高级货币 |
| `/开启钓鱼后台管理` | 启动Web管理后台 |
| `/关闭钓鱼后台管理` | 关闭Web管理后台 |
| `/同步道具` | 从 initial_data.py 同步道具模板（管理员） |
| `/代理上线 [用户ID]` | 扮演指定用户 |
| `/代理下线` | 结束扮演 |

---

## 👥 社区与贡献

### 🤝 如何贡献

我们欢迎各种形式的贡献！无论您是开发者、用户还是爱好者，都可以为项目做出贡献：

#### 对于开发者
- 🐛 **报告Bug**：在 [Issues](https://github.com/xxlemon-io/astrbot_plugin_fishing/issues) 中报告发现的问题
- 💡 **功能建议**：提出新功能想法和改进建议
- 🔧 **代码贡献**：提交 Pull Request 改进代码
- 📖 **文档完善**：帮助完善文档和注释

#### 对于用户
- ⭐ **Star支持**：给项目点个Star，让更多人看到
- 📝 **使用反馈**：分享使用体验和建议
- 🐛 **问题报告**：报告使用中遇到的问题
- 💬 **社区讨论**：参与社区讨论，分享使用技巧

### 📋 贡献指南

1. **Fork** 本仓库
2. 创建您的特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交您的更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开一个 **Pull Request**

### 📄 代码规范

- 遵循 Python PEP 8 代码规范
- 添加适当的注释和文档字符串
- 确保代码通过所有测试
- 提交信息使用清晰的中文描述

### 🏆 贡献者

感谢所有为这个项目做出贡献的开发者们！

<a href="https://github.com/xxlemon-io/astrbot_plugin_fishing/graphs/contributors">
  <img src="https://contrib.rocks/image?repo=xxlemon-io/astrbot_plugin_fishing" />
</a>

## 📞 支持与联系

- 🐛 **问题反馈**：[GitHub Issues](https://github.com/xxlemon-io/astrbot_plugin_fishing/issues)
- 💬 **讨论交流**：[GitHub Discussions](https://github.com/xxlemon-io/astrbot_plugin_fishing/discussions)
- 📧 **邮件联系**：通过 GitHub 个人资料联系

## 🙏 致谢与项目来源

本项目基于以下开源项目进行开发：

- **原始版本**：[@baa131/astrbot_plugin_fishing](https://github.com/baa131/astrbot_plugin_fishing) v1.0.0
- **基础版本**：[@tinkerbellqwq/astrbot_plugin_fishing](https://github.com/tinkerbellqwq/astrbot_plugin_fishing) v1.4.6

感谢原作者的贡献和开源精神，让我们能够在此基础上继续改进和完善这个项目。

## 📜 开源协议与法律声明

本项目基于 [AGPL-3.0](https://opensource.org/licenses/AGPL-3.0) 开源协议发布。

### 协议要点
- ✅ **商业使用**：允许商业使用
- ✅ **修改**：允许修改和分发
- ✅ **专利使用**：允许专利使用
- ✅ **私人使用**：允许私人使用
- ⚠️ **开源要求**：基于本项目的衍生作品必须同样开源
- ⚠️ **网络服务**：通过网络提供服务的衍生作品也必须开源

### 免责声明
- 本项目仅供学习和娱乐使用
- 使用者需自行承担使用风险
- 开发者不对任何直接或间接损失负责

---

<div align="center">

**如果这个项目对您有帮助，请给我们一个 ⭐ Star！**

Made with ❤️ by the AstrBot Fishing Plugin Community

</div>
