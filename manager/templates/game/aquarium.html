{% extends "game/layout_game.html" %}

{% block title %}é’“é±¼æ¸¸æˆ - æ°´æ—ç®±{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- æ°´æ—ç®±æ¦‚è§ˆ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-water me-2"></i>
                        æ°´æ—ç®±æ¦‚è§ˆ
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="upgradeAquarium()">
                        <i class="fas fa-arrow-up me-1"></i>
                        å‡çº§å®¹é‡
                    </button>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-fish text-primary fa-2x mb-2"></i>
                                <div class="stat-value" id="totalFish">0</div>
                                <div class="stat-label">æ€»é±¼æ•°</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-box text-info fa-2x mb-2"></i>
                                <div class="stat-value" id="capacity">0</div>
                                <div class="stat-label">å®¹é‡</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-coins text-warning fa-2x mb-2"></i>
                                <div class="stat-value" id="totalValue">0</div>
                                <div class="stat-label">æ€»ä»·å€¼</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar" id="capacityProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="capacityText">0 / 0</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é±¼ç±»ç®¡ç† -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-fish me-2"></i>
                        é±¼ç±»ç®¡ç†
                    </h5>
                </div>
                <div class="card-body">
                    <div id="fishList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">åŠ è½½é±¼ç±»åˆ—è¡¨ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œé¢æ¿ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        æ“ä½œé¢æ¿
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <button class="btn btn-game btn-game-success w-100" onclick="showAddFishModal()">
                                <i class="fas fa-plus me-2"></i>
                                æ·»åŠ é±¼ç±»
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-warning w-100" onclick="showRemoveFishModal()">
                                <i class="fas fa-minus me-2"></i>
                                ç§»å‡ºé±¼ç±»
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-info w-100" onclick="loadAquarium()">
                                <i class="fas fa-sync me-2"></i>
                                åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-primary w-100" onclick="showAquariumHelp()">
                                <i class="fas fa-question-circle me-2"></i>
                                å¸®åŠ©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ é±¼ç±»æ¨¡æ€æ¡† -->
<div class="modal fade" id="addFishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    æ·»åŠ é±¼ç±»åˆ°æ°´æ—ç®±
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFishForm">
                    <div class="mb-3">
                        <label for="addFishSelect" class="form-label">é€‰æ‹©é±¼ç±»</label>
                        <select class="form-select" id="addFishSelect" required>
                            <option value="">è¯·é€‰æ‹©é±¼ç±»</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addFishQuantity" class="form-label">æ•°é‡</label>
                        <input type="number" class="form-control" id="addFishQuantity" value="1" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addFishToAquarium()">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- ç§»å‡ºé±¼ç±»æ¨¡æ€æ¡† -->
<div class="modal fade" id="removeFishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-minus me-2"></i>
                    ä»æ°´æ—ç®±ç§»å‡ºé±¼ç±»
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="removeFishForm">
                    <div class="mb-3">
                        <label for="removeFishSelect" class="form-label">é€‰æ‹©é±¼ç±»</label>
                        <select class="form-select" id="removeFishSelect" required>
                            <option value="">è¯·é€‰æ‹©é±¼ç±»</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="removeFishQuantity" class="form-label">æ•°é‡</label>
                        <input type="number" class="form-control" id="removeFishQuantity" value="1" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="removeFishFromAquarium()">ç§»å‡º</button>
            </div>
        </div>
    </div>
</div>

<!-- æ°´æ—ç®±å¸®åŠ©æ¨¡æ€æ¡† -->
<div class="modal fade" id="aquariumHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>
                    æ°´æ—ç®±å¸®åŠ©
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="help-content">
                    <h6>ğŸ  æ°´æ—ç®±ç³»ç»Ÿè¯´æ˜</h6>
                    <ul>
                        <li><strong>å®‰å…¨å­˜å‚¨ï¼š</strong>æ°´æ—ç®±æ˜¯ä¸€ä¸ªå®‰å…¨çš„å­˜å‚¨ç©ºé—´ï¼Œé±¼æ”¾åœ¨é‡Œé¢ä¸ä¼šè¢«å·</li>
                        <li><strong>é»˜è®¤å®¹é‡ï¼š</strong>é»˜è®¤å®¹é‡50æ¡ï¼Œå¯ä»¥é€šè¿‡å‡çº§å¢åŠ å®¹é‡</li>
                        <li><strong>è‡ªåŠ¨å­˜å‚¨ï¼š</strong>ä»å¸‚åœºè´­ä¹°çš„é±¼é»˜è®¤æ”¾å…¥æ°´æ—ç®±</li>
                        <li><strong>æ­£å¸¸äº¤æ˜“ï¼š</strong>å¯ä»¥æ­£å¸¸ä¸Šæ¶å’Œè´­ä¹°</li>
                    </ul>
                    
                    <h6>ğŸ“‹ å¯ç”¨æ“ä½œ</h6>
                    <ul>
                        <li><strong>æŸ¥çœ‹æ°´æ—ç®±ï¼š</strong>æŸ¥çœ‹æ°´æ—ç®±ä¸­çš„é±¼ç±»</li>
                        <li><strong>æ·»åŠ é±¼ç±»ï¼š</strong>å°†é±¼ä»é±¼å¡˜æ”¾å…¥æ°´æ—ç®±</li>
                        <li><strong>ç§»å‡ºé±¼ç±»ï¼š</strong>å°†é±¼ä»æ°´æ—ç®±ç§»å›é±¼å¡˜</li>
                        <li><strong>å‡çº§å®¹é‡ï¼š</strong>å‡çº§æ°´æ—ç®±å®¹é‡</li>
                    </ul>
                    
                    <h6>ğŸ’¡ ä½¿ç”¨æŠ€å·§</h6>
                    <ul>
                        <li>ä½¿ç”¨é±¼ç±»IDï¼ˆå¦‚F3ï¼‰æˆ–çº¯æ•°å­—IDæ¥æ“ä½œ</li>
                        <li>å®šæœŸæ£€æŸ¥æ°´æ—ç®±å®¹é‡ï¼ŒåŠæ—¶å‡çº§</li>
                        <li>å°†ç¨€æœ‰é±¼ç±»æ”¾å…¥æ°´æ—ç®±ä¿æŠ¤</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-item {
    padding: 1rem 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark-color);
}

.fish-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    transition: var(--transition);
}

.fish-item:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.fish-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.fish-info {
    flex: 1;
}

.fish-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.fish-details {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.fish-quantity {
    font-weight: 600;
    color: var(--primary-color);
}

.fish-actions {
    display: flex;
    gap: 0.5rem;
}

.rarity-1 { background: #94a3b8; }
.rarity-2 { background: #0ea5e9; }
.rarity-3 { background: #06b6d4; }
.rarity-4 { background: #8b5cf6; }
.rarity-5 { background: #f59e0b; }
.rarity-6 { background: #10b981; }
.rarity-7 { background: #ef4444; }
.rarity-8 { background: #fbbf24; }
.rarity-9 { background: #dc2626; }
.rarity-10 { background: #7c2d12; }

.help-content h6 {
    color: var(--primary-color);
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.help-content ul {
    padding-left: 1.5rem;
}

.help-content li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class AquariumModule {
    constructor() {
        this.aquariumData = null;
        this.pondFish = [];
        
        this.init();
    }
    
    async init() {
        await this.loadAquarium();
        await this.loadPondFish();
    }
    
    async loadAquarium() {
        try {
            const response = await gameApp.apiCall('/aquarium', 'GET');
            if (response.success) {
                this.aquariumData = response.data;
                this.updateDisplay();
            }
        } catch (error) {
            console.error('Failed to load aquarium:', error);
        }
    }
    
    async loadPondFish() {
        try {
            const response = await gameApp.apiCall('/inventory/fish', 'GET');
            if (response.success) {
                this.pondFish = response.data.fishes || [];
            }
        } catch (error) {
            console.error('Failed to load pond fish:', error);
        }
    }
    
    updateDisplay() {
        if (!this.aquariumData) return;
        
        const stats = this.aquariumData.stats || {};
        const fishes = this.aquariumData.fishes || [];
        
        // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
        document.getElementById('totalFish').textContent = gameApp.formatNumber(stats.total_count || 0);
        document.getElementById('capacity').textContent = gameApp.formatNumber(stats.capacity || 0);
        document.getElementById('totalValue').textContent = gameApp.formatNumber(stats.total_value || 0);
        
        // æ›´æ–°å®¹é‡è¿›åº¦æ¡
        const capacityPercent = stats.capacity > 0 ? (stats.total_count / stats.capacity) * 100 : 0;
        document.getElementById('capacityProgress').style.width = `${capacityPercent}%`;
        document.getElementById('capacityText').textContent = `${gameApp.formatNumber(stats.total_count || 0)} / ${gameApp.formatNumber(stats.capacity || 0)}`;
        
        // æ›´æ–°é±¼ç±»åˆ—è¡¨
        this.renderFishList(fishes);
    }
    
    renderFishList(fishes) {
        const container = document.getElementById('fishList');
        
        if (fishes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-water"></i>
                    <p>æ°´æ—ç®±æ˜¯ç©ºçš„ï¼Œå¿«å»é’“é±¼å§ï¼</p>
                </div>
            `;
            return;
        }
        
        // æŒ‰ç¨€æœ‰åº¦åˆ†ç»„
        const fishesByRarity = {};
        fishes.forEach(fish => {
            const rarity = fish.rarity || 1;
            if (!fishesByRarity[rarity]) {
                fishesByRarity[rarity] = [];
            }
            fishesByRarity[rarity].push(fish);
        });
        
        let fishHtml = '';
        Object.keys(fishesByRarity).sort((a, b) => b - a).forEach(rarity => {
            const fishList = fishesByRarity[rarity];
            fishHtml += `
                <div class="mb-3">
                    <h6 class="text-muted">${'â˜…'.repeat(rarity)} ç¨€æœ‰åº¦ ${rarity}</h6>
                    ${fishList.map(fish => this.renderFishItem(fish)).join('')}
                </div>
            `;
        });
        
        container.innerHTML = fishHtml;
    }
    
    renderFishItem(fish) {
        const fishId = fish.fish_id || 0;
        const fcode = `F${fishId}`;
        
        return `
            <div class="fish-item">
                <div class="fish-icon rarity-${fish.rarity || 1}">
                    <i class="fas fa-fish"></i>
                </div>
                <div class="fish-info">
                    <div class="fish-name">${fish.name}</div>
                    <div class="fish-details">
                        ID: ${fcode} | ä»·å€¼: ${gameApp.formatNumber(fish.base_value)} é‡‘å¸/ä¸ª
                    </div>
                    <div class="fish-quantity">æ•°é‡: ${gameApp.formatNumber(fish.quantity)}</div>
                </div>
                <div class="fish-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="quickAddFish(${fishId})">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="quickRemoveFish(${fishId})">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
        `;
    }
    
    showAddFishModal() {
        const modal = new bootstrap.Modal(document.getElementById('addFishModal'));
        
        // å¡«å……é±¼ç±»é€‰æ‹©
        const select = document.getElementById('addFishSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©é±¼ç±»</option>';
        
        this.pondFish.forEach(fish => {
            const option = document.createElement('option');
            option.value = fish.fish_id;
            option.textContent = `${fish.name} (${gameApp.formatNumber(fish.quantity)}æ¡)`;
            select.appendChild(option);
        });
        
        modal.show();
    }
    
    showRemoveFishModal() {
        const modal = new bootstrap.Modal(document.getElementById('removeFishModal'));
        
        // å¡«å……æ°´æ—ç®±ä¸­çš„é±¼ç±»é€‰æ‹©
        const select = document.getElementById('removeFishSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©é±¼ç±»</option>';
        
        if (this.aquariumData && this.aquariumData.fishes) {
            this.aquariumData.fishes.forEach(fish => {
                const option = document.createElement('option');
                option.value = fish.fish_id;
                option.textContent = `${fish.name} (${gameApp.formatNumber(fish.quantity)}æ¡)`;
                select.appendChild(option);
            });
        }
        
        modal.show();
    }
    
    async addFishToAquarium() {
        const fishId = document.getElementById('addFishSelect').value;
        const quantity = parseInt(document.getElementById('addFishQuantity').value);
        
        if (!fishId) {
            gameApp.showToast('è¯·é€‰æ‹©é±¼ç±»', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/aquarium/add', 'POST', {
                fish_id: parseInt(fishId),
                quantity: quantity
            });
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadAquarium();
                await this.loadPondFish();
                bootstrap.Modal.getInstance(document.getElementById('addFishModal')).hide();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async removeFishFromAquarium() {
        const fishId = document.getElementById('removeFishSelect').value;
        const quantity = parseInt(document.getElementById('removeFishQuantity').value);
        
        if (!fishId) {
            gameApp.showToast('è¯·é€‰æ‹©é±¼ç±»', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/aquarium/remove', 'POST', {
                fish_id: parseInt(fishId),
                quantity: quantity
            });
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadAquarium();
                await this.loadPondFish();
                bootstrap.Modal.getInstance(document.getElementById('removeFishModal')).hide();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('ç§»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async upgradeAquarium() {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/aquarium/upgrade', 'POST');
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadAquarium();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('å‡çº§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    showAquariumHelp() {
        const modal = new bootstrap.Modal(document.getElementById('aquariumHelpModal'));
        modal.show();
    }
    
    async quickAddFish(fishId) {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/aquarium/add', 'POST', {
                fish_id: fishId,
                quantity: 1
            });
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadAquarium();
                await this.loadPondFish();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async quickRemoveFish(fishId) {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/aquarium/remove', 'POST', {
                fish_id: fishId,
                quantity: 1
            });
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadAquarium();
                await this.loadPondFish();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('ç§»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
}

// å…¨å±€å‡½æ•°
function showAddFishModal() {
    if (window.aquariumModule) {
        window.aquariumModule.showAddFishModal();
    }
}

function showRemoveFishModal() {
    if (window.aquariumModule) {
        window.aquariumModule.showRemoveFishModal();
    }
}

function addFishToAquarium() {
    if (window.aquariumModule) {
        window.aquariumModule.addFishToAquarium();
    }
}

function removeFishFromAquarium() {
    if (window.aquariumModule) {
        window.aquariumModule.removeFishFromAquarium();
    }
}

function upgradeAquarium() {
    if (window.aquariumModule) {
        window.aquariumModule.upgradeAquarium();
    }
}

function loadAquarium() {
    if (window.aquariumModule) {
        window.aquariumModule.loadAquarium();
    }
}

function showAquariumHelp() {
    if (window.aquariumModule) {
        window.aquariumModule.showAquariumHelp();
    }
}

function quickAddFish(fishId) {
    if (window.aquariumModule) {
        window.aquariumModule.quickAddFish(fishId);
    }
}

function quickRemoveFish(fishId) {
    if (window.aquariumModule) {
        window.aquariumModule.quickRemoveFish(fishId);
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    window.aquariumModule = new AquariumModule();
});
</script>
{% endblock %}
