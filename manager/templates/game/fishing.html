{% extends "game/layout_game.html" %}

{% block title %}é’“é±¼æ¸¸æˆ - é’“é±¼{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- å½“å‰åŒºåŸŸä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        å½“å‰é’“é±¼åŒºåŸŸ
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="showZoneSelector()">
                        <i class="fas fa-exchange me-1"></i>
                        åˆ‡æ¢åŒºåŸŸ
                    </button>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h4 class="zone-name mb-1" id="currentZoneName">æœªçŸ¥åŒºåŸŸ</h4>
                            <p class="text-muted mb-0" id="currentZoneDesc">åŒºåŸŸæè¿°</p>
                        </div>
                        <div class="col-4 text-end">
                            <div class="zone-cost">
                                <i class="fas fa-coins text-warning me-1"></i>
                                <span id="fishingCost">10</span> é‡‘å¸/æ¬¡
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é’“é±¼ä¸»ç•Œé¢ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card text-center">
                <div class="card-body">
                    <!-- é’“é±¼æŒ‰é’®åŒºåŸŸ -->
                    <div class="fishing-area mb-4">
                        <div class="fishing-pond" id="fishingPond">
                            <div class="water-surface">
                                <div class="water-ripple" id="waterRipple"></div>
                                <div class="fishing-line" id="fishingLine"></div>
                                <div class="fish-shadow" id="fishShadow"></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-game btn-game-primary btn-game-xl" id="fishingBtn" onclick="startFishing()">
                            <i class="fas fa-fish me-2"></i>
                            <span id="fishingBtnText">å¼€å§‹é’“é±¼</span>
                        </button>
                        
                        <div class="fishing-cooldown mt-3" id="fishingCooldown" style="display: none;">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <span>å†·å´ä¸­: </span>
                            <span class="countdown-time" id="cooldownTime">00:00</span>
                        </div>
                    </div>

                    <!-- é’“é±¼çŠ¶æ€ä¿¡æ¯ -->
                    <div class="fishing-status">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="status-item">
                                    <i class="fas fa-play-circle text-success fa-lg mb-1"></i>
                                    <div class="status-label">è‡ªåŠ¨é’“é±¼</div>
                                    <div class="status-value" id="autoFishingStatus">å…³é—­</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="status-item">
                                    <i class="fas fa-chart-line text-info fa-lg mb-1"></i>
                                    <div class="status-label">æˆåŠŸç‡</div>
                                    <div class="status-value" id="successRate">100%</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="status-item">
                                    <i class="fas fa-star text-warning fa-lg mb-1"></i>
                                    <div class="status-label">ç¨€æœ‰åº¦åŠ æˆ</div>
                                    <div class="status-value" id="rarityBonus">+0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        é’“é±¼æ§åˆ¶
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <button class="btn btn-game btn-game-success w-100" onclick="toggleAutoFishing()">
                                <i class="fas fa-play-circle me-2"></i>
                                <span id="autoFishingBtnText">å¼€å¯è‡ªåŠ¨é’“é±¼</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-info w-100" onclick="showZoneSelector()">
                                <i class="fas fa-map me-2"></i>
                                åˆ‡æ¢åŒºåŸŸ
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-warning w-100" onclick="showFishingHistory()">
                                <i class="fas fa-history me-2"></i>
                                é’“é±¼è®°å½•
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-primary w-100" onclick="showFishingStats()">
                                <i class="fas fa-chart-bar me-2"></i>
                                é’“é±¼ç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘é’“é±¼è®°å½• -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-fish me-2"></i>
                        æœ€è¿‘é’“é±¼è®°å½•
                    </h5>
                </div>
                <div class="card-body">
                    <div id="fishingHistory">
                        <div class="text-center text-muted">
                            <i class="fas fa-fish fa-2x mb-2"></i>
                            <p>æš‚æ— é’“é±¼è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŒºåŸŸé€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="zoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map me-2"></i>
                    é€‰æ‹©é’“é±¼åŒºåŸŸ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="zoneList">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">åŠ è½½åŒºåŸŸåˆ—è¡¨ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é’“é±¼ç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="fishingResultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-fish me-2"></i>
                    é’“é±¼ç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="fishingResultContent">
                <!-- é’“é±¼ç»“æœå†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.fishing-area {
    position: relative;
    padding: 2rem 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.fishing-pond {
    width: 200px;
    height: 200px;
    margin: 0 auto 2rem;
    position: relative;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.water-surface {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
}

.water-ripple {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    animation: ripple 2s infinite;
}

.fishing-line {
    position: absolute;
    top: 20%;
    left: 50%;
    width: 2px;
    height: 60%;
    background: linear-gradient(to bottom, #8B4513, #654321);
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.fishing-line.show {
    opacity: 1;
}

.fish-shadow {
    position: absolute;
    bottom: 20%;
    left: 50%;
    width: 30px;
    height: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.fish-shadow.show {
    opacity: 1;
}

@keyframes ripple {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(4);
        opacity: 0;
    }
}

@keyframes fishing {
    0% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
    100% {
        transform: translateY(0);
    }
}

.fishing-animation {
    animation: fishing 0.5s ease-in-out;
}

.fishing-cooldown {
    color: var(--warning-color);
    font-weight: 600;
}

.countdown-time {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
}

.status-item {
    padding: 1rem 0.5rem;
}

.status-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.status-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-color);
}

.zone-card {
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 1rem;
    transition: var(--transition);
    cursor: pointer;
}

.zone-card:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.zone-card.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.zone-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.zone-description {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.zone-cost {
    color: var(--warning-color);
    font-weight: 600;
}

.zone-requirements {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.fishing-record {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.fishing-record:hover {
    background: rgba(102, 126, 234, 0.05);
}

.fishing-record:last-child {
    border-bottom: none;
}

.fish-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: white;
}

.fish-info {
    flex: 1;
}

.fish-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.fish-details {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.pokedex-stats {
    max-height: 400px;
    overflow-y: auto;
}

.fish-stat-item {
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    background: rgba(102, 126, 234, 0.05);
    transition: var(--transition);
}

.fish-stat-item:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.fish-value {
    font-weight: 600;
    color: var(--success-color);
}

.fish-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class FishingModule {
    constructor() {
        this.currentZone = null;
        this.zones = [];
        this.isFishing = false;
        this.cooldownTimer = null;
        this.userInfo = null;
        this.lastCooldownCheck = 0; // ä¸Šæ¬¡æ£€æŸ¥å†·å´çš„æ—¶é—´æˆ³
        this.cooldownCheckThrottle = 5000; // å†·å´æ£€æŸ¥é˜²æŠ–é—´éš”ï¼ˆ5ç§’ï¼‰
        
        this.init();
    }
    
    async init() {
        await this.loadUserInfo();
        await this.loadZones();
        await this.loadFishingHistory();
        await this.checkCooldownStatus();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // å®šæœŸåˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        setInterval(() => {
            this.loadUserInfo();
        }, 30000);
        
        // å½“é¡µé¢é‡æ–°å˜ä¸ºå¯è§æ—¶æ£€æŸ¥å†·å´çŠ¶æ€ï¼ˆç”¨æˆ·ä»å…¶ä»–æ ‡ç­¾é¡µè¿”å›ï¼‰
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.checkCooldownStatus();
            }
        });
        
        // å½“çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥å†·å´çŠ¶æ€
        window.addEventListener('focus', () => {
            this.checkCooldownStatus();
        });
    }
    
    async loadUserInfo() {
        try {
            const response = await gameApp.apiCall('/profile', 'GET');
            if (response.success) {
                this.userInfo = response.data;
                this.updateDisplay();
            }
        } catch (error) {
            console.error('Failed to load user info:', error);
        }
    }
    
    async loadZones() {
        try {
            const response = await gameApp.apiCall('/zones', 'GET');
            if (response.success) {
                this.zones = response.data;
                this.updateZoneDisplay();
            }
        } catch (error) {
            console.error('Failed to load zones:', error);
        }
    }
    
    async loadFishingHistory() {
        try {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨è·å–é’“é±¼è®°å½•çš„API
            // æš‚æ—¶æ˜¾ç¤ºå ä½å†…å®¹
            const container = document.getElementById('fishingHistory');
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-fish fa-2x mb-2"></i>
                    <p>æš‚æ— é’“é±¼è®°å½•</p>
                </div>
            `;
        } catch (error) {
            console.error('Failed to load fishing history:', error);
        }
    }
    
    async checkCooldownStatus() {
        const now = Date.now();
        // é˜²æŠ–ï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡æ£€æŸ¥ä¸åˆ°5ç§’ï¼Œè·³è¿‡
        if (now - this.lastCooldownCheck < this.cooldownCheckThrottle) {
            return;
        }
        
        try {
            const response = await gameApp.apiCall('/fishing/cooldown', 'GET');
            if (response.success) {
                const data = response.data;
                if (data.is_on_cooldown) {
                    this.startCooldown(data.remaining_seconds);
                } else {
                    this.clearCooldown();
                }
                this.lastCooldownCheck = now;
            }
        } catch (error) {
            console.error('Failed to check cooldown status:', error);
        }
    }
    
    // åªåœ¨ç”¨æˆ·å°è¯•é’“é±¼æ—¶æ£€æŸ¥å†·å´çŠ¶æ€
    async checkCooldownBeforeFishing() {
        try {
            const response = await gameApp.apiCall('/fishing/cooldown', 'GET');
            if (response.success) {
                const data = response.data;
                if (data.is_on_cooldown) {
                    this.startCooldown(data.remaining_seconds);
                    return false; // ä»åœ¨å†·å´ä¸­
                } else {
                    this.clearCooldown();
                    return true; // å¯ä»¥é’“é±¼
                }
            }
        } catch (error) {
            console.error('Failed to check cooldown status:', error);
        }
        return true; // å‡ºé”™æ—¶å…è®¸é’“é±¼
    }
    
    updateDisplay() {
        if (!this.userInfo) return;
        
        // æ›´æ–°è‡ªåŠ¨é’“é±¼çŠ¶æ€
        const autoFishingStatus = document.getElementById('autoFishingStatus');
        const autoFishingBtnText = document.getElementById('autoFishingBtnText');
        
        if (this.userInfo.auto_fishing_enabled) {
            autoFishingStatus.textContent = 'å¼€å¯';
            autoFishingBtnText.textContent = 'å…³é—­è‡ªåŠ¨é’“é±¼';
        } else {
            autoFishingStatus.textContent = 'å…³é—­';
            autoFishingBtnText.textContent = 'å¼€å¯è‡ªåŠ¨é’“é±¼';
        }
    }
    
    updateZoneDisplay() {
        if (!this.userInfo || this.zones.length === 0) return;
        
        // æ‰¾åˆ°å½“å‰åŒºåŸŸ
        const currentZone = this.zones.find(zone => zone.id === this.userInfo.fishing_zone_id);
        if (currentZone) {
            this.currentZone = currentZone;
            document.getElementById('currentZoneName').textContent = currentZone.name;
            document.getElementById('currentZoneDesc').textContent = currentZone.description || 'æš‚æ— æè¿°';
            document.getElementById('fishingCost').textContent = gameApp.formatNumber(currentZone.fishing_cost || 10);
        }
    }
    
    async startFishing() {
        if (this.isFishing) return;
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å†·å´ä¸­
        const fishingBtn = document.getElementById('fishingBtn');
        if (fishingBtn.disabled) return;
        
        // åœ¨é’“é±¼å‰æ£€æŸ¥å†·å´çŠ¶æ€
        const canFish = await this.checkCooldownBeforeFishing();
        if (!canFish) {
            return; // ä»åœ¨å†·å´ä¸­ï¼Œä¸æ‰§è¡Œé’“é±¼
        }
        
        try {
            this.isFishing = true;
            this.updateFishingButton(true);
            this.startFishingAnimation();
            
            const response = await gameApp.apiCall('/fishing/cast', 'POST');
            
            if (response.success) {
                const fish = response.data.fish;
                const message = response.data.message;
                
                // æ˜¾ç¤ºé’“é±¼ç»“æœ
                this.showFishingResult(fish, message);
                
                // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                await this.loadUserInfo();
                
                // æ˜¾ç¤ºå†·å´æ—¶é—´
                this.startCooldown(response.data.cooldown_seconds || 180);
                
            } else {
                gameApp.showToast(response.message, 'danger');
                
                // å¦‚æœæ˜¯å†·å´ä¸­ï¼Œæ˜¾ç¤ºå†·å´æ—¶é—´
                if (response.message.includes('ç­‰å¾…') || response.message.includes('å†·å´')) {
                    this.startCooldown(response.data.cooldown_seconds || 180);
                } else {
                    // å¦‚æœä¸æ˜¯å†·å´é—®é¢˜ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                    this.isFishing = false;
                    this.updateFishingButton(false);
                    this.stopFishingAnimation();
                }
            }
        } catch (error) {
            gameApp.showToast('é’“é±¼å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
            this.isFishing = false;
            this.updateFishingButton(false);
            this.stopFishingAnimation();
        }
    }
    
    updateFishingButton(fishing) {
        const fishingBtn = document.getElementById('fishingBtn');
        const fishingBtnText = document.getElementById('fishingBtnText');
        
        if (fishing) {
            fishingBtn.disabled = true;
            fishingBtnText.textContent = 'é’“é±¼ä¸­...';
        } else {
            fishingBtn.disabled = false;
            fishingBtnText.textContent = 'å¼€å§‹é’“é±¼';
        }
    }
    
    startFishingAnimation() {
        const fishingLine = document.getElementById('fishingLine');
        const fishShadow = document.getElementById('fishShadow');
        const waterRipple = document.getElementById('waterRipple');
        
        fishingLine.classList.add('show');
        fishShadow.classList.add('show');
        waterRipple.style.animation = 'ripple 1s infinite';
    }
    
    stopFishingAnimation() {
        const fishingLine = document.getElementById('fishingLine');
        const fishShadow = document.getElementById('fishShadow');
        const waterRipple = document.getElementById('waterRipple');
        
        fishingLine.classList.remove('show');
        fishShadow.classList.remove('show');
        waterRipple.style.animation = 'none';
    }
    
    showFishingResult(fish, message) {
        if (fish) {
            const resultHtml = `
                <div class="fishing-result">
                    <div class="fish-icon bg-${this.getRarityColor(fish.rarity)} mb-3">
                        <i class="fas fa-fish"></i>
                    </div>
                    <h4 class="fish-name">${fish.name}</h4>
                    <div class="fish-details mb-2">
                        <span class="star-rating">${'â˜…'.repeat(fish.rarity)}</span>
                        <span class="ms-2">é‡é‡: ${gameApp.formatNumber(fish.weight)}å…‹</span>
                    </div>
                    <div class="fish-value">ä»·å€¼: ${gameApp.formatNumber(fish.value)} é‡‘å¸</div>
                </div>
            `;
            
            document.getElementById('fishingResultContent').innerHTML = resultHtml;
            const modal = new bootstrap.Modal(document.getElementById('fishingResultModal'));
            modal.show();
        } else {
            gameApp.showToast(message, 'info');
        }
    }
    
    getRarityColor(rarity) {
        const colors = {
            1: 'secondary',
            2: 'success',
            3: 'primary',
            4: 'info',
            5: 'warning',
            6: 'dark',
            7: 'danger',
            8: 'warning',
            9: 'info',
            10: 'danger'
        };
        return colors[rarity] || 'secondary';
    }
    
    startCooldown(seconds = 180) {
        const cooldownSection = document.getElementById('fishingCooldown');
        const cooldownTime = document.getElementById('cooldownTime');
        const fishingBtn = document.getElementById('fishingBtn');
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (this.cooldownTimer) {
            clearTimeout(this.cooldownTimer);
        }
        
        cooldownSection.style.display = 'block';
        fishingBtn.disabled = true;
        
        // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„å†·å´æ—¶é—´
        let remaining = seconds;
        
        const updateCooldown = () => {
            cooldownTime.textContent = gameApp.formatTime(remaining);
            remaining--;
            
            if (remaining < 0) {
                cooldownSection.style.display = 'none';
                fishingBtn.disabled = false;
                this.cooldownTimer = null;
                return;
            }
            
            this.cooldownTimer = setTimeout(updateCooldown, 1000);
        };
        
        updateCooldown();
    }
    
    clearCooldown() {
        const cooldownSection = document.getElementById('fishingCooldown');
        const fishingBtn = document.getElementById('fishingBtn');
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (this.cooldownTimer) {
            clearTimeout(this.cooldownTimer);
            this.cooldownTimer = null;
        }
        
        // éšè—å†·å´æ˜¾ç¤ºï¼Œå¯ç”¨æŒ‰é’®
        cooldownSection.style.display = 'none';
        fishingBtn.disabled = false;
    }
    
    async toggleAutoFishing() {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/fishing/toggle-auto', 'POST');
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadUserInfo();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    showZoneSelector() {
        const modal = new bootstrap.Modal(document.getElementById('zoneModal'));
        this.renderZoneList();
        modal.show();
    }
    
    renderZoneList() {
        const container = document.getElementById('zoneList');
        
        if (this.zones.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-map fa-2x mb-2"></i>
                    <p>æš‚æ— å¯ç”¨åŒºåŸŸ</p>
                </div>
            `;
            return;
        }
        
        const zonesHtml = this.zones.map(zone => `
            <div class="zone-card ${zone.id === this.userInfo?.fishing_zone_id ? 'selected' : ''}" 
                 onclick="selectZone(${zone.id})">
                <div class="zone-name">${zone.name}</div>
                <div class="zone-description">${zone.description || 'æš‚æ— æè¿°'}</div>
                <div class="zone-cost">
                    <i class="fas fa-coins text-warning me-1"></i>
                    ${gameApp.formatNumber(zone.fishing_cost || 10)} é‡‘å¸/æ¬¡
                </div>
                ${zone.requires_pass ? '<div class="zone-requirements">éœ€è¦é€šè¡Œè¯</div>' : ''}
            </div>
        `).join('');
        
        container.innerHTML = zonesHtml;
    }
    
    async selectZone(zoneId) {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/zones/switch', 'POST', { zone_id: zoneId });
            
            if (response.success) {
                gameApp.showToast('åŒºåŸŸåˆ‡æ¢æˆåŠŸ', 'success');
                await this.loadUserInfo();
                bootstrap.Modal.getInstance(document.getElementById('zoneModal')).hide();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('åˆ‡æ¢åŒºåŸŸå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async showFishingHistory() {
        try {
            const response = await gameApp.apiCall('/fishing/history', 'GET');
            if (response.success) {
                const logs = response.data.logs || [];
                this.renderFishingHistory(logs);
            } else {
                gameApp.showToast('è·å–é’“é±¼è®°å½•å¤±è´¥', 'danger');
            }
        } catch (error) {
            gameApp.showToast('è·å–é’“é±¼è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        }
    }
    
    renderFishingHistory(logs) {
        if (logs.length === 0) {
            gameApp.showToast('æš‚æ— é’“é±¼è®°å½•', 'info');
            return;
        }
        
        const historyHtml = logs.map(log => `
            <div class="fishing-record">
                <div class="fish-icon bg-primary">
                    <i class="fas fa-fish"></i>
                </div>
                <div class="fish-info">
                    <div class="fish-name">${log.message || 'é’“é±¼è®°å½•'}</div>
                    <div class="fish-details">
                        æ—¶é—´: ${new Date(log.timestamp).toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
        
        // æ›´æ–°é’“é±¼è®°å½•æ˜¾ç¤º
        document.getElementById('fishingHistory').innerHTML = historyHtml;
    }
    
    async showFishingStats() {
        try {
            const response = await gameApp.apiCall('/fishing/pokedex', 'GET');
            if (response.success) {
                const pokedex = response.data.pokedex || [];
                this.renderFishingStats(pokedex);
            } else {
                gameApp.showToast('è·å–é±¼ç±»å›¾é‰´å¤±è´¥', 'danger');
            }
        } catch (error) {
            gameApp.showToast('è·å–é±¼ç±»å›¾é‰´å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        }
    }
    
    renderFishingStats(pokedex) {
        if (pokedex.length === 0) {
            gameApp.showToast('æš‚æ— é±¼ç±»å›¾é‰´æ•°æ®', 'info');
            return;
        }
        
        // æŒ‰ç¨€æœ‰åº¦åˆ†ç»„
        const fishesByRarity = {};
        pokedex.forEach(fish => {
            const rarity = fish.rarity || 1;
            if (!fishesByRarity[rarity]) {
                fishesByRarity[rarity] = [];
            }
            fishesByRarity[rarity].push(fish);
        });
        
        let statsHtml = '<div class="pokedex-stats">';
        Object.keys(fishesByRarity).sort((a, b) => b - a).forEach(rarity => {
            const fishList = fishesByRarity[rarity];
            statsHtml += `
                <div class="mb-3">
                    <h6 class="text-muted">${'â˜…'.repeat(rarity)} ç¨€æœ‰åº¦ ${rarity} (${fishList.length}ç§)</h6>
                    <div class="row g-2">
                        ${fishList.map(fish => `
                            <div class="col-6">
                                <div class="fish-stat-item">
                                    <div class="fish-name">${fish.name}</div>
                                    <div class="fish-details">
                                        é‡é‡: ${gameApp.formatNumber(fish.weight)}å…‹ | ä»·å€¼: ${gameApp.formatNumber(fish.value)}é‡‘å¸
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        statsHtml += '</div>';
        
        // æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
        const modal = new bootstrap.Modal(document.getElementById('fishingResultModal'));
        document.getElementById('fishingResultContent').innerHTML = `
            <div class="text-center mb-3">
                <h4>ğŸ  é±¼ç±»å›¾é‰´ç»Ÿè®¡</h4>
                <p>å…±å‘ç° ${pokedex.length} ç§é±¼ç±»</p>
            </div>
            ${statsHtml}
        `;
        modal.show();
    }
}

// å…¨å±€å‡½æ•°
function startFishing() {
    if (window.fishingModule) {
        window.fishingModule.startFishing();
    }
}

function toggleAutoFishing() {
    if (window.fishingModule) {
        window.fishingModule.toggleAutoFishing();
    }
}

function showZoneSelector() {
    if (window.fishingModule) {
        window.fishingModule.showZoneSelector();
    }
}

function selectZone(zoneId) {
    if (window.fishingModule) {
        window.fishingModule.selectZone(zoneId);
    }
}

function showFishingHistory() {
    if (window.fishingModule) {
        window.fishingModule.showFishingHistory();
    }
}

function showFishingStats() {
    if (window.fishingModule) {
        window.fishingModule.showFishingStats();
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    window.fishingModule = new FishingModule();
});
</script>
{% endblock %}
