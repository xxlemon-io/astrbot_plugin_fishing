{% extends "game/layout_game.html" %}

{% block title %}é’“é±¼æ¸¸æˆ - æŠ½å¡{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- å¡æ± é€‰æ‹© -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cube me-2"></i>
                        é€‰æ‹©å¡æ± 
                    </h5>
                </div>
                <div class="card-body">
                    <div id="poolList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">åŠ è½½å¡æ± åˆ—è¡¨ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ½å¡åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card text-center">
                <div class="card-body">
                    <div id="gachaArea">
                        <div class="gacha-machine mb-4">
                            <div class="machine-body">
                                <div class="machine-screen" id="machineScreen">
                                    <i class="fas fa-question-circle fa-5x text-muted"></i>
                                    <p class="mt-3">é€‰æ‹©ä¸€ä¸ªå¡æ± å¼€å§‹æŠ½å¡</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gacha-controls" id="gachaControls" style="display: none;">
                            <div class="row g-3">
                                <div class="col-6">
                                    <button class="btn btn-game btn-game-primary w-100" onclick="singleDraw()">
                                        <i class="fas fa-cube me-2"></i>
                                        å•æŠ½
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-game btn-game-warning w-100" onclick="tenDraw()">
                                        <i class="fas fa-cube-d20 me-2"></i>
                                        åè¿
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“¦å¼¹åŠŸèƒ½ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bomb me-2"></i>
                        æ“¦å¼¹
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-8">
                            <input type="number" class="form-control" id="wipeBombAmount" placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢" min="1">
                        </div>
                        <div class="col-4">
                            <button class="btn btn-game btn-game-danger w-100" onclick="wipeBomb()">
                                <i class="fas fa-bomb me-1"></i>
                                æ“¦å¼¹
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            å¿«æ·è¾“å…¥: 
                            <button class="btn btn-sm btn-outline-secondary" onclick="setWipeBombAmount('allin')">æ¢­å“ˆ</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setWipeBombAmount('halfin')">æ¢­ä¸€åŠ</button>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ½å¡è®°å½• -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        æŠ½å¡è®°å½•
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadGachaHistory()">
                        <i class="fas fa-sync me-1"></i>
                        åˆ·æ–°
                    </button>
                </div>
                <div class="card-body">
                    <div id="gachaHistory">
                        <div class="text-center text-muted">
                            <i class="fas fa-cube fa-2x mb-2"></i>
                            <p>æš‚æ— æŠ½å¡è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“¦å¼¹è®°å½• -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bomb me-2"></i>
                        æ“¦å¼¹è®°å½•
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadWipeBombHistory()">
                        <i class="fas fa-sync me-1"></i>
                        åˆ·æ–°
                    </button>
                </div>
                <div class="card-body">
                    <div id="wipeBombHistory">
                        <div class="text-center text-muted">
                            <i class="fas fa-bomb fa-2x mb-2"></i>
                            <p>æš‚æ— æ“¦å¼¹è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æŠ½å¡ç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="gachaResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gift me-2"></i>
                    æŠ½å¡ç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="gachaResultContent">
                <!-- æŠ½å¡ç»“æœå†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- å¡æ± è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="poolDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    å¡æ± è¯¦æƒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="poolDetailsContent">
                <!-- å¡æ± è¯¦æƒ…å†…å®¹ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.gacha-machine {
    position: relative;
    margin: 0 auto;
    max-width: 300px;
}

.machine-body {
    background: linear-gradient(135deg, #0ea5e9 0%, #1e3a8a 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
}

.machine-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
    animation: shine 3s infinite;
}

.machine-screen {
    background: rgba(0, 0, 0, 0.8);
    border-radius: 15px;
    padding: 2rem;
    color: white;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.pool-card {
    border: 2px solid var(--card-border);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 1rem;
    transition: var(--transition);
    cursor: pointer;
}

.pool-card:hover {
    border-color: var(--primary-color);
    background: rgba(56, 189, 248, 0.05);
}

.pool-card.selected {
    border-color: var(--primary-color);
    background: rgba(56, 189, 248, 0.1);
}

.pool-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.pool-description {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.pool-cost {
    color: var(--warning-color);
    font-weight: 600;
}

.gacha-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.gacha-item:hover {
    background: rgba(56, 189, 248, 0.05);
}

.gacha-item:last-child {
    border-bottom: none;
}

.item-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: white;
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.item-details {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.rarity-1 { background: #94a3b8; }
.rarity-2 { background: #0ea5e9; }
.rarity-3 { background: #06b6d4; }
.rarity-4 { background: #8b5cf6; }
.rarity-5 { background: #f59e0b; }
.rarity-6 { background: #10b981; }
.rarity-7 { background: #ef4444; }
.rarity-8 { background: #fbbf24; }
.rarity-9 { background: #dc2626; }
.rarity-10 { background: #7c2d12; }

.wipe-bomb-record {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.wipe-bomb-record:hover {
    background: rgba(56, 189, 248, 0.05);
}

.wipe-bomb-record:last-child {
    border-bottom: none;
}

.wipe-bomb-info {
    flex: 1;
}

.wipe-bomb-amount {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.wipe-bomb-details {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.wipe-bomb-result {
    text-align: right;
}

.profit {
    color: var(--success-color);
    font-weight: 600;
}

.loss {
    color: var(--danger-color);
    font-weight: 600;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class GachaModule {
    constructor() {
        this.pools = [];
        this.selectedPool = null;
        this.userInfo = null;
        
        this.init();
    }
    
    async init() {
        await this.loadUserInfo();
        await this.loadPools();
        await this.loadGachaHistory();
        await this.loadWipeBombHistory();
        
        // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
        this.startTimeUpdateTimer();
    }
    
    startTimeUpdateTimer() {
        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
        setInterval(() => {
            this.updatePoolTimeDisplays();
        }, 60000); // 60ç§’
    }
    
    updatePoolTimeDisplays() {
        // æ›´æ–°æ‰€æœ‰é™æ—¶å¡æ± çš„æ—¶é—´æ˜¾ç¤º
        const poolCards = document.querySelectorAll('.pool-card');
        poolCards.forEach(card => {
            const poolId = parseInt(card.getAttribute('onclick').match(/\d+/)[0]);
            const pool = this.pools.find(p => p.gacha_pool_id === poolId);
            
            if (pool && pool.is_limited_time && pool.open_until) {
                const isExpired = this.isPoolExpired(pool.open_until);
                const timeLeft = this.getTimeLeft(pool.open_until);
                
                // æ›´æ–°å¡ç‰‡çŠ¶æ€
                if (isExpired) {
                    card.classList.add('expired');
                } else {
                    card.classList.remove('expired');
                }
                
                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                const timeElement = card.querySelector('.pool-time');
                if (timeElement) {
                    if (isExpired) {
                        timeElement.textContent = 'å·²è¿‡æœŸ';
                        timeElement.className = 'pool-time text-danger';
                    } else if (timeLeft) {
                        timeElement.textContent = `å‰©ä½™: ${timeLeft}`;
                        timeElement.className = 'pool-time text-warning';
                    }
                }
            }
        });
    }
    
    async loadUserInfo() {
        try {
            const response = await gameApp.apiCall('/profile', 'GET');
            if (response.success) {
                this.userInfo = response.data;
                // æ›´æ–°å³ä¸Šè§’æ˜¾ç¤º
                this.updateTopBar();
            }
        } catch (error) {
            console.error('Failed to load user info:', error);
        }
    }
    
    updateTopBar() {
        if (this.userInfo) {
            document.getElementById('userCoins').textContent = gameApp.formatNumber(this.userInfo.coins || 0);
            document.getElementById('userPremium').textContent = gameApp.formatNumber(this.userInfo.premium_currency || 0);
        }
    }
    
    async loadPools() {
        try {
            const response = await gameApp.apiCall('/gacha/pools', 'GET');
            if (response.success) {
                this.pools = response.data.pools || [];
                this.renderPools();
            }
        } catch (error) {
            console.error('Failed to load pools:', error);
        }
    }
    
    renderPools() {
        const container = document.getElementById('poolList');
        
        if (this.pools.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-cube fa-2x mb-2"></i>
                    <p>æš‚æ— å¯ç”¨å¡æ± </p>
                </div>
            `;
            return;
        }
        
        const poolsHtml = this.pools.map(pool => {
            const isLimited = pool.is_limited_time && pool.open_until;
            const isExpired = isLimited && this.isPoolExpired(pool.open_until);
            const timeLeft = isLimited ? this.getTimeLeft(pool.open_until) : null;
            
            return `
                <div class="pool-card ${pool.gacha_pool_id === this.selectedPool?.gacha_pool_id ? 'selected' : ''} ${isExpired ? 'expired' : ''}" 
                     onclick="selectPool(${pool.gacha_pool_id})">
                    <div class="pool-name">
                        ${pool.name}
                        ${isLimited ? '<i class="fas fa-clock ms-2 text-warning"></i>' : ''}
                    </div>
                    <div class="pool-description">${pool.description || 'æš‚æ— æè¿°'}</div>
                    ${isLimited && timeLeft ? `
                        <div class="pool-time ${isExpired ? 'text-danger' : 'text-warning'}">
                            <i class="fas fa-clock me-1"></i>
                            ${isExpired ? 'å·²è¿‡æœŸ' : `å‰©ä½™: ${timeLeft}`}
                        </div>
                    ` : ''}
                    <div class="pool-cost">
                        ${pool.cost_premium_currency ? 
                            `<i class="fas fa-gem text-info me-1"></i>${pool.cost_premium_currency} é«˜çº§è´§å¸/æ¬¡` : 
                            `<i class="fas fa-coins text-warning me-1"></i>${pool.cost_coins} é‡‘å¸/æ¬¡`
                        }
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="showPoolDetails(${pool.gacha_pool_id}, event)">
                            <i class="fas fa-info-circle me-1"></i>
                            è¯¦æƒ…
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = poolsHtml;
    }
    
    selectPool(poolId) {
        const pool = this.pools.find(pool => pool.gacha_pool_id === poolId);
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (pool.is_limited_time && pool.open_until && this.isPoolExpired(pool.open_until)) {
            gameApp.showToast('è¯¥å¡æ± å·²è¿‡æœŸï¼Œæ— æ³•é€‰æ‹©', 'warning');
            return;
        }
        
        this.selectedPool = pool;
        
        // æ›´æ–°UI
        document.querySelectorAll('.pool-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // æ˜¾ç¤ºæŠ½å¡æ§åˆ¶
        document.getElementById('gachaControls').style.display = 'block';
        
        // æ›´æ–°æœºå™¨å±å¹•
        const screen = document.getElementById('machineScreen');
        screen.innerHTML = `
            <i class="fas fa-cube fa-5x text-primary"></i>
            <h4 class="mt-3">${this.selectedPool.name}</h4>
            <p>å‡†å¤‡å¼€å§‹æŠ½å¡</p>
        `;
    }
    
    isPoolExpired(openUntil) {
        if (!openUntil) return false;
        
        try {
            // è§£ææ—¶é—´å­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šç§æ ¼å¼
            let endTime;
            if (openUntil.includes('T')) {
                endTime = new Date(openUntil);
            } else {
                // å‡è®¾æ˜¯æœ¬åœ°æ—¶é—´æ ¼å¼ YYYY-MM-DD HH:MM
                endTime = new Date(openUntil.replace(' ', 'T'));
            }
            
            return endTime < new Date();
        } catch (e) {
            console.error('æ—¶é—´è§£æé”™è¯¯:', e);
            return false;
        }
    }
    
    getTimeLeft(openUntil) {
        if (!openUntil) return null;
        
        try {
            let endTime;
            if (openUntil.includes('T')) {
                endTime = new Date(openUntil);
            } else {
                endTime = new Date(openUntil.replace(' ', 'T'));
            }
            
            const now = new Date();
            const diff = endTime - now;
            
            if (diff <= 0) return null;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}å¤©${hours}å°æ—¶`;
            } else if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else {
                return `${minutes}åˆ†é’Ÿ`;
            }
        } catch (e) {
            console.error('æ—¶é—´è®¡ç®—é”™è¯¯:', e);
            return null;
        }
    }
    
    async singleDraw() {
        if (!this.selectedPool) {
            gameApp.showToast('è¯·å…ˆé€‰æ‹©å¡æ± ', 'warning');
            return;
        }
        
        // æ£€æŸ¥å¡æ± æ˜¯å¦è¿‡æœŸ
        if (this.selectedPool.is_limited_time && this.selectedPool.open_until && this.isPoolExpired(this.selectedPool.open_until)) {
            gameApp.showToast('è¯¥å¡æ± å·²è¿‡æœŸï¼Œæ— æ³•æŠ½å¡', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/gacha/draw', 'POST', {
                pool_id: this.selectedPool.gacha_pool_id
            });
            
            if (response.success) {
                this.showGachaResult(response.data.results || []);
                await this.loadUserInfo();
                await this.loadGachaHistory();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('æŠ½å¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async tenDraw() {
        if (!this.selectedPool) {
            gameApp.showToast('è¯·å…ˆé€‰æ‹©å¡æ± ', 'warning');
            return;
        }
        
        // æ£€æŸ¥å¡æ± æ˜¯å¦è¿‡æœŸ
        if (this.selectedPool.is_limited_time && this.selectedPool.open_until && this.isPoolExpired(this.selectedPool.open_until)) {
            gameApp.showToast('è¯¥å¡æ± å·²è¿‡æœŸï¼Œæ— æ³•æŠ½å¡', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/gacha/draw-ten', 'POST', {
                pool_id: this.selectedPool.gacha_pool_id
            });
            
            if (response.success) {
                this.showGachaResult(response.data.results || []);
                await this.loadUserInfo();
                await this.loadGachaHistory();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('åè¿æŠ½å¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    showGachaResult(results) {
        if (results.length === 0) {
            gameApp.showToast('æ²¡æœ‰è·å¾—ä»»ä½•ç‰©å“', 'info');
            return;
        }
        
        const resultHtml = results.map(item => `
            <div class="gacha-item">
                <div class="item-icon rarity-${item.rarity || 1}">
                    <i class="fas fa-${this.getItemIcon(item.type)}"></i>
                </div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-details">
                        ${item.type === 'coins' ? 
                            `æ•°é‡: ${item.quantity}` : 
                            `ç¨€æœ‰åº¦: ${'â˜…'.repeat(item.rarity || 1)}`
                        }
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('gachaResultContent').innerHTML = `
            <div class="text-center mb-3">
                <h4>ğŸ‰ æŠ½å¡æˆåŠŸï¼</h4>
                <p>è·å¾—äº† ${results.length} ä»¶ç‰©å“</p>
            </div>
            <div class="gacha-results">
                ${resultHtml}
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('gachaResultModal'));
        modal.show();
    }
    
    getItemIcon(type) {
        const icons = {
            'coins': 'coins',
            'rod': 'fishing-rod',
            'accessory': 'gem',
            'item': 'box',
            'fish': 'fish'
        };
        return icons[type] || 'gift';
    }
    
    async wipeBomb() {
        const amount = document.getElementById('wipeBombAmount').value;
        if (!amount || amount <= 0) {
            gameApp.showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•å…¥é‡‘é¢', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/gacha/wipe-bomb', 'POST', {
                contribution_amount: parseInt(amount)
            });
            
            if (response.success) {
                const data = response.data;
                const profit = data.profit || 0;
                const multiplier = data.multiplier || 0;
                
                let message = `æŠ•å…¥: ${data.contribution} é‡‘å¸\n`;
                message += `å€ç‡: ${multiplier.toFixed(2)}x\n`;
                message += `å¥–åŠ±: ${data.reward} é‡‘å¸\n`;
                message += `ç›ˆäº: ${profit >= 0 ? '+' : ''}${profit} é‡‘å¸`;
                
                gameApp.showToast(message, profit >= 0 ? 'success' : 'warning');
                
                await this.loadUserInfo();
                await this.loadWipeBombHistory();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('æ“¦å¼¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    setWipeBombAmount(type) {
        if (!this.userInfo) return;
        
        const coins = this.userInfo.coins || 0;
        let amount = 0;
        
        if (type === 'allin') {
            amount = coins;
        } else if (type === 'halfin') {
            amount = Math.floor(coins / 2);
        }
        
        document.getElementById('wipeBombAmount').value = amount;
    }
    
    async loadGachaHistory() {
        try {
            const response = await gameApp.apiCall('/gacha/history', 'GET');
            if (response.success) {
                const records = response.data.records || [];
                this.renderGachaHistory(records);
            }
        } catch (error) {
            console.error('Failed to load gacha history:', error);
        }
    }
    
    renderGachaHistory(records) {
        const container = document.getElementById('gachaHistory');
        
        if (records.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-cube fa-2x mb-2"></i>
                    <p>æš‚æ— æŠ½å¡è®°å½•</p>
                </div>
            `;
            return;
        }
        
        const historyHtml = records.map(record => `
            <div class="gacha-item">
                <div class="item-icon rarity-${record.rarity}">
                    <i class="fas fa-${this.getItemIcon(record.item_type)}"></i>
                </div>
                <div class="item-info">
                    <div class="item-name">${record.item_name}</div>
                    <div class="item-details">
                        ç¨€æœ‰åº¦: ${'â˜…'.repeat(record.rarity)} | 
                        æ—¶é—´: ${new Date(record.timestamp).toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = historyHtml;
    }
    
    async loadWipeBombHistory() {
        try {
            const response = await gameApp.apiCall('/gacha/wipe-bomb/history', 'GET');
            if (response.success) {
                const records = response.data.logs || [];
                this.renderWipeBombHistory(records);
            }
        } catch (error) {
            console.error('Failed to load wipe bomb history:', error);
        }
    }
    
    renderWipeBombHistory(records) {
        const container = document.getElementById('wipeBombHistory');
        
        if (records.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-bomb fa-2x mb-2"></i>
                    <p>æš‚æ— æ“¦å¼¹è®°å½•</p>
                </div>
            `;
            return;
        }
        
        const historyHtml = records.map(record => {
            const profit = record.reward - record.contribution;
            const profitClass = profit >= 0 ? 'profit' : 'loss';
            const profitText = profit >= 0 ? `+${profit}` : profit;
            
            return `
                <div class="wipe-bomb-record">
                    <div class="wipe-bomb-info">
                        <div class="wipe-bomb-amount">æŠ•å…¥: ${record.contribution} é‡‘å¸</div>
                        <div class="wipe-bomb-details">
                            å€ç‡: ${record.multiplier.toFixed(2)}x | 
                            æ—¶é—´: ${new Date(record.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div class="wipe-bomb-result">
                        <div>å¥–åŠ±: ${record.reward} é‡‘å¸</div>
                        <div class="${profitClass}">ç›ˆäº: ${profitText} é‡‘å¸</div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = historyHtml;
    }
    
    async showPoolDetails(poolId, event) {
        event.stopPropagation();
        
        try {
            const response = await gameApp.apiCall(`/gacha/pools/${poolId}`, 'GET');
            if (response.success) {
                const pool = response.data.pool;
                const probabilities = response.data.probabilities || [];
                
                const isLimited = pool.is_limited_time && pool.open_until;
                const isExpired = isLimited && this.isPoolExpired(pool.open_until);
                const timeLeft = isLimited ? this.getTimeLeft(pool.open_until) : null;
                
                const detailsHtml = `
                    <div class="pool-details">
                        <h4>
                            ${pool.name}
                            ${isLimited ? '<i class="fas fa-clock ms-2 text-warning"></i>' : ''}
                        </h4>
                        <p class="text-muted">${pool.description}</p>
                        ${isLimited ? `
                            <div class="pool-time-info mb-3 p-3 rounded ${isExpired ? 'bg-danger' : 'bg-warning'} text-white">
                                <i class="fas fa-clock me-2"></i>
                                <strong>é™æ—¶å¡æ± </strong>
                                <br>
                                ${isExpired ? 
                                    `å·²è¿‡æœŸ (æˆªæ­¢: ${pool.open_until})` : 
                                    `å‰©ä½™æ—¶é—´: ${timeLeft} (æˆªæ­¢: ${pool.open_until})`
                                }
                            </div>
                        ` : ''}
                        <div class="pool-cost mb-3">
                            ${pool.cost_premium_currency ? 
                                `<i class="fas fa-gem text-info me-1"></i>${pool.cost_premium_currency} é«˜çº§è´§å¸/æ¬¡` : 
                                `<i class="fas fa-coins text-warning me-1"></i>${pool.cost_coins} é‡‘å¸/æ¬¡`
                            }
                        </div>
                        <h5>ç‰©å“æ¦‚ç‡</h5>
                        <div class="probability-list">
                            ${probabilities.map(item => `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <div>
                                        <span class="me-2">${'â˜…'.repeat(item.item_rarity)}</span>
                                        <span>${item.item_name}</span>
                                    </div>
                                    <span class="badge bg-primary">${(item.probability * 100).toFixed(2)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('poolDetailsContent').innerHTML = detailsHtml;
                const modal = new bootstrap.Modal(document.getElementById('poolDetailsModal'));
                modal.show();
            }
        } catch (error) {
            gameApp.showToast('è·å–å¡æ± è¯¦æƒ…å¤±è´¥', 'danger');
        }
    }
}

// å…¨å±€å‡½æ•°
function selectPool(poolId) {
    if (window.gachaModule) {
        window.gachaModule.selectPool(poolId);
    }
}

function singleDraw() {
    if (window.gachaModule) {
        window.gachaModule.singleDraw();
    }
}

function tenDraw() {
    if (window.gachaModule) {
        window.gachaModule.tenDraw();
    }
}

function wipeBomb() {
    if (window.gachaModule) {
        window.gachaModule.wipeBomb();
    }
}

function setWipeBombAmount(type) {
    if (window.gachaModule) {
        window.gachaModule.setWipeBombAmount(type);
    }
}

function loadGachaHistory() {
    if (window.gachaModule) {
        window.gachaModule.loadGachaHistory();
    }
}

function loadWipeBombHistory() {
    if (window.gachaModule) {
        window.gachaModule.loadWipeBombHistory();
    }
}

function showPoolDetails(poolId, event) {
    if (window.gachaModule) {
        window.gachaModule.showPoolDetails(poolId, event);
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    window.gachaModule = new GachaModule();
});
</script>
{% endblock %}
