{% extends "game/layout_game.html" %}

{% block title %}钓鱼游戏 - 首页{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 欢迎区域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-body text-center">
                    <h2 class="text-gradient mb-3">
                        <i class="fas fa-fish me-2"></i>
                        欢迎来到钓鱼游戏！
                    </h2>
                    <p class="text-muted mb-0">开始您的钓鱼之旅，收集稀有鱼类，成为钓鱼大师！</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户状态卡片 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-circle me-2"></i>
                        我的状态
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshUserInfo()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-coins text-warning fa-2x mb-2"></i>
                                <div class="stat-value" id="userCoinsDisplay">0</div>
                                <div class="stat-label">金币</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-gem text-info fa-2x mb-2"></i>
                                <div class="stat-value" id="userPremiumDisplay">0</div>
                                <div class="stat-label">钻石</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <i class="fas fa-fish text-primary fa-2x mb-2"></i>
                                <div class="stat-value" id="userFishingCount">0</div>
                                <div class="stat-label">钓鱼次数</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 当前装备 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        当前装备
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- 鱼竿 -->
                        <div class="col-6 col-md-3">
                            <div class="equipment-item text-center">
                                <i class="fas fa-anchor text-primary fa-2x mb-2"></i>
                                <div class="equipment-name" id="currentRod">无鱼竿</div>
                                <div class="equipment-level" id="rodLevel"></div>
                                <div class="equipment-durability" id="rodDurability"></div>
                            </div>
                        </div>
                        <!-- 饰品 -->
                        <div class="col-6 col-md-3">
                            <div class="equipment-item text-center">
                                <i class="fas fa-gem text-info fa-2x mb-2"></i>
                                <div class="equipment-name" id="currentAccessory">无饰品</div>
                                <div class="equipment-level" id="accessoryLevel"></div>
                            </div>
                        </div>
                        <!-- 鱼饵 -->
                        <div class="col-6 col-md-3">
                            <div class="equipment-item text-center">
                                <i class="fas fa-bug text-warning fa-2x mb-2"></i>
                                <div class="equipment-name" id="currentBait">无鱼饵</div>
                                <div class="equipment-level" id="baitLevel"></div>
                                <div class="equipment-quantity" id="baitQuantity"></div>
                            </div>
                        </div>
                        <!-- 钓鱼区域 -->
                        <div class="col-6 col-md-3">
                            <div class="equipment-item text-center">
                                <i class="fas fa-map-marker-alt text-success fa-2x mb-2"></i>
                                <div class="equipment-name" id="currentZone">未知区域</div>
                                <div class="equipment-level" id="zoneRareFish"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        状态信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 col-md-3">
                            <div class="status-item text-center">
                                <i class="fas fa-calendar-check text-success fa-2x mb-2"></i>
                                <div class="status-name" id="signStatus">今日签到</div>
                                <div class="status-value" id="signValue">未签到</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="status-item text-center">
                                <i class="fas fa-bomb text-danger fa-2x mb-2"></i>
                                <div class="status-name" id="wipeStatus">擦弹次数</div>
                                <div class="status-value" id="wipeValue">0 次</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="status-item text-center">
                                <i class="fas fa-robot text-primary fa-2x mb-2"></i>
                                <div class="status-name" id="autoStatus">自动钓鱼</div>
                                <div class="status-value" id="autoValue">已关闭</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="status-item text-center">
                                <i class="fas fa-fish text-warning fa-2x mb-2"></i>
                                <div class="status-name" id="pondStatus">鱼塘</div>
                                <div class="status-value" id="pondValue">0 条</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        快捷操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <button class="btn btn-game btn-game-primary btn-game-lg w-100" onclick="goFishing()">
                                <i class="fas fa-fish me-2"></i>
                                开始钓鱼
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-success btn-game-lg w-100" onclick="signIn()">
                                <i class="fas fa-calendar-check me-2"></i>
                                每日签到
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-warning btn-game-lg w-100" onclick="toggleAutoFishing()">
                                <i class="fas fa-play-circle me-2"></i>
                                <span id="autoFishingText">开启自动钓鱼</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-game btn-game-info btn-game-lg w-100" onclick="switchZone()">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                切换区域
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 钓鱼冷却状态 -->
    <div class="row mb-4" id="cooldownSection" style="display: none;">
        <div class="col-12">
            <div class="game-card">
                <div class="card-body text-center">
                    <i class="fas fa-clock text-warning fa-2x mb-2"></i>
                    <h5>钓鱼冷却中</h5>
                    <p class="text-muted mb-2">请等待以下时间后再次钓鱼：</p>
                    <div class="countdown-display">
                        <span class="countdown-time" id="cooldownTime">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近钓鱼记录 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        最近钓鱼记录
                    </h5>
                    <a href="{{ url_for('game_bp.game_fishing') }}" class="btn btn-sm btn-outline-primary">
                        查看全部
                    </a>
                </div>
                <div class="card-body">
                    <div id="recentFishingRecords">
                        <div class="text-center text-muted">
                            <i class="fas fa-fish fa-2x mb-2"></i>
                            <p>暂无钓鱼记录</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 游戏统计 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        游戏统计
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-item">
                                <i class="fas fa-weight text-success fa-lg mb-1"></i>
                                <div class="stat-value" id="totalWeight">0</div>
                                <div class="stat-label">总重量(克)</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-item">
                                <i class="fas fa-coins text-warning fa-lg mb-1"></i>
                                <div class="stat-value" id="totalEarned">0</div>
                                <div class="stat-label">总收益(金币)</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-item">
                                <i class="fas fa-calendar-day text-info fa-lg mb-1"></i>
                                <div class="stat-value" id="consecutiveDays">0</div>
                                <div class="stat-label">连续登录(天)</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-item">
                                <i class="fas fa-water text-primary fa-lg mb-1"></i>
                                <div class="stat-value" id="pondCapacity">0</div>
                                <div class="stat-label">鱼塘容量</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 区域选择模态框 -->
<div class="modal fade" id="zoneSelectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    选择钓鱼区域
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="zoneList" class="row g-3">
                    <!-- 区域列表将在这里动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-item {
    padding: 1rem 0.5rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--dark-color);
    margin: 0.5rem 0;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.equipment-item {
    padding: 1rem;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.equipment-item:hover {
    background: rgba(56, 189, 248, 0.05);
}

.equipment-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.equipment-level {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.equipment-durability {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.equipment-quantity {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.status-item {
    padding: 1rem;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.status-item:hover {
    background: rgba(56, 189, 248, 0.05);
}

.status-name {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.status-value {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.countdown-display {
    font-size: 2rem;
    font-weight: bold;
    color: var(--warning-color);
    font-family: 'Courier New', monospace;
}

.fishing-record {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.fishing-record:hover {
    background: rgba(56, 189, 248, 0.05);
}

.fishing-record:last-child {
    border-bottom: none;
}

.fish-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
}

.fish-info {
    flex: 1;
}

.fish-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.fish-details {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.fish-value {
    font-weight: 600;
    color: var(--success-color);
}

.zone-card {
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--card-bg);
    height: 100%;
}

.zone-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.zone-card.selected {
    border-color: var(--primary-color);
    background: var(--primary-gradient);
    color: white;
}

.zone-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--dark-color);
}

.zone-card.selected .zone-name {
    color: white;
}

.zone-description {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.zone-card.selected .zone-description {
    color: rgba(255, 255, 255, 0.8);
}

.zone-cost {
    font-size: 0.9rem;
    color: var(--warning-color);
    font-weight: 500;
}

.zone-card.selected .zone-cost {
    color: rgba(255, 255, 255, 0.9);
}

.zone-requirements {
    font-size: 0.8rem;
    color: var(--danger-color);
    margin-top: 0.5rem;
    font-weight: 500;
}

.zone-card.selected .zone-requirements {
    color: rgba(255, 255, 255, 0.8);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class GameHome {
    constructor() {
        this.userInfo = null;
        this.isFishing = false;
        this.cooldownTimer = null;
        this.lastCooldownCheck = 0; // 上次检查冷却的时间戳
        this.cooldownCheckThrottle = 5000; // 冷却检查防抖间隔（5秒）
        this.zones = []; // 区域列表
        this.init();
    }
    
    async init() {
        await this.loadUserInfo();
        await this.loadRecentRecords();
        await this.checkCooldownStatus();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // 定期刷新用户信息
        setInterval(() => {
            this.loadUserInfo();
        }, 30000);
        
        // 当页面重新变为可见时检查冷却状态（用户从其他标签页返回）
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.checkCooldownStatus();
            }
        });
        
        // 当窗口重新获得焦点时检查冷却状态
        window.addEventListener('focus', () => {
            this.checkCooldownStatus();
        });
    }
    
    async loadUserInfo() {
        try {
            const response = await gameApp.apiCall('/profile', 'GET');
            if (response.success) {
                this.userInfo = response.data;
                this.updateUserDisplay();
            } else {
                // 检查是否需要重定向到登录页面
                if (response.redirect && response.redirect.includes('/login')) {
                    window.location.href = response.redirect;
                    return;
                }
                console.error('Failed to load user info:', response.message);
            }
        } catch (error) {
            console.error('Failed to load user info:', error);
        }
    }
    
    updateUserDisplay() {
        if (!this.userInfo) return;
        
        // 更新状态显示
        document.getElementById('userCoinsDisplay').textContent = gameApp.formatNumber(this.userInfo.coins || 0);
        document.getElementById('userPremiumDisplay').textContent = gameApp.formatNumber(this.userInfo.premium_currency || 0);
        document.getElementById('userFishingCount').textContent = gameApp.formatNumber(this.userInfo.total_fishing_count || 0);
        document.getElementById('totalWeight').textContent = gameApp.formatNumber(this.userInfo.total_weight_caught || 0);
        document.getElementById('totalEarned').textContent = gameApp.formatNumber(this.userInfo.total_coins_earned || 0);
        document.getElementById('consecutiveDays').textContent = gameApp.formatNumber(this.userInfo.consecutive_login_days || 0);
        document.getElementById('pondCapacity').textContent = gameApp.formatNumber(this.userInfo.fish_pond_capacity || 0);
        
        // 更新自动钓鱼状态
        const autoFishingText = document.getElementById('autoFishingText');
        if (this.userInfo.auto_fishing_enabled) {
            autoFishingText.textContent = '关闭自动钓鱼';
        } else {
            autoFishingText.textContent = '开启自动钓鱼';
        }
        
        // 更新装备信息
        this.updateEquipmentDisplay();
        
        // 更新状态信息
        this.updateStatusDisplay();
    }
    
    updateEquipmentDisplay() {
        if (!this.userInfo) return;
        
        // 更新鱼竿信息
        const currentRod = document.getElementById('currentRod');
        const rodLevel = document.getElementById('rodLevel');
        const rodDurability = document.getElementById('rodDurability');
        
        if (this.userInfo.equipped_rod) {
            const rod = this.userInfo.equipped_rod;
            currentRod.textContent = rod.name || '未知鱼竿';
            rodLevel.textContent = `+${rod.refine_level || 0}`;
            
            // 显示耐久度信息
            if (rod.current_durability !== undefined && rod.max_durability !== undefined) {
                const durabilityRatio = rod.current_durability / rod.max_durability;
                let durabilityColor = 'var(--success-color)';
                if (durabilityRatio <= 0.3) {
                    durabilityColor = 'var(--danger-color)';
                } else if (durabilityRatio <= 0.6) {
                    durabilityColor = 'var(--warning-color)';
                }
                rodDurability.innerHTML = `<span style="color: ${durabilityColor}">耐久: ${rod.current_durability}/${rod.max_durability}</span>`;
            } else if (rod.current_durability === null) {
                rodDurability.innerHTML = '<span style="color: var(--primary-color)">无限耐久</span>';
            } else {
                rodDurability.textContent = '';
            }
        } else {
            currentRod.textContent = '无鱼竿';
            rodLevel.textContent = '';
            rodDurability.textContent = '';
        }
        
        // 更新饰品信息
        const currentAccessory = document.getElementById('currentAccessory');
        const accessoryLevel = document.getElementById('accessoryLevel');
        
        if (this.userInfo.equipped_accessory) {
            const accessory = this.userInfo.equipped_accessory;
            currentAccessory.textContent = accessory.name || '未知饰品';
            accessoryLevel.textContent = `+${accessory.refine_level || 0}`;
        } else {
            currentAccessory.textContent = '无饰品';
            accessoryLevel.textContent = '';
        }
        
        // 更新鱼饵信息
        const currentBait = document.getElementById('currentBait');
        const baitLevel = document.getElementById('baitLevel');
        const baitQuantity = document.getElementById('baitQuantity');
        
        if (this.userInfo.current_bait) {
            const bait = this.userInfo.current_bait;
            currentBait.textContent = bait.name || '未知鱼饵';
            baitLevel.textContent = `★${bait.rarity || 1}`;
            baitQuantity.textContent = `剩余: ${bait.quantity || 0}`;
        } else {
            currentBait.textContent = '无鱼饵';
            baitLevel.textContent = '';
            baitQuantity.textContent = '';
        }
        
        // 更新钓鱼区域信息
        const currentZone = document.getElementById('currentZone');
        const zoneRareFish = document.getElementById('zoneRareFish');
        
        if (this.userInfo.fishing_zone) {
            const zone = this.userInfo.fishing_zone;
            currentZone.textContent = zone.name || '未知区域';
            
            const quota = zone.rare_fish_quota || 0;
            const caught = zone.rare_fish_caught || 0;
            const remaining = quota - caught;
            
            if (quota === 0) {
                zoneRareFish.innerHTML = '<span style="color: var(--text-muted)">无稀有鱼</span>';
            } else if (remaining > 0) {
                zoneRareFish.innerHTML = `<span style="color: var(--success-color)">剩余稀有鱼: ${remaining}条</span>`;
            } else {
                zoneRareFish.innerHTML = '<span style="color: var(--text-muted)">今日稀有鱼已捕完</span>';
            }
        } else {
            currentZone.textContent = '未知区域';
            zoneRareFish.textContent = '';
        }
    }
    
    updateStatusDisplay() {
        if (!this.userInfo) return;
        
        // 更新签到状态
        const signValue = document.getElementById('signValue');
        if (this.userInfo.signed_in_today) {
            signValue.innerHTML = '<span style="color: var(--success-color)">已签到</span>';
        } else {
            signValue.innerHTML = '<span style="color: var(--danger-color)">未签到</span>';
        }
        
        // 更新擦弹次数
        const wipeValue = document.getElementById('wipeValue');
        const wipeRemaining = this.userInfo.wipe_bomb_remaining || 0;
        if (wipeRemaining > 0) {
            wipeValue.innerHTML = `<span style="color: var(--danger-color)">剩余 ${wipeRemaining} 次</span>`;
        } else {
            wipeValue.innerHTML = '<span style="color: var(--text-muted)">已用完</span>';
        }
        
        // 更新自动钓鱼状态
        const autoValue = document.getElementById('autoValue');
        if (this.userInfo.auto_fishing_enabled) {
            autoValue.innerHTML = '<span style="color: var(--success-color)">已开启</span>';
        } else {
            autoValue.innerHTML = '<span style="color: var(--danger-color)">已关闭</span>';
        }
        
        // 更新鱼塘信息
        const pondValue = document.getElementById('pondValue');
        const pondInfo = this.userInfo.pond_info || {};
        const totalCount = pondInfo.total_count || 0;
        const totalValue = pondInfo.total_value || 0;
        
        if (totalCount > 0) {
            pondValue.innerHTML = `<span style="color: var(--primary-color)">${totalCount} 条</span><br><small style="color: var(--text-muted)">价值: ${gameApp.formatNumber(totalValue)} 金币</small>`;
        } else {
            pondValue.innerHTML = '<span style="color: var(--text-muted)">0 条</span>';
        }
    }
    
    async loadRecentRecords() {
        try {
            const response = await gameApp.apiCall('/fishing/history', 'GET');
            if (response.success) {
                const logs = response.data.logs || [];
                this.renderRecentRecords(logs);
            } else {
                // 如果API调用失败，显示占位内容
                const container = document.getElementById('recentFishingRecords');
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-fish fa-2x mb-2"></i>
                        <p>暂无钓鱼记录</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load recent records:', error);
            // 出错时显示占位内容
            const container = document.getElementById('recentFishingRecords');
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-fish fa-2x mb-2"></i>
                    <p>暂无钓鱼记录</p>
                </div>
            `;
        }
    }
    
    renderRecentRecords(logs) {
        const container = document.getElementById('recentFishingRecords');
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-fish fa-2x mb-2"></i>
                    <p>暂无钓鱼记录</p>
                </div>
            `;
            return;
        }
        
        // 只显示最近5条记录
        const recentLogs = logs.slice(0, 5);
        const historyHtml = recentLogs.map(log => `
            <div class="fishing-record">
                <div class="fish-icon bg-primary">
                    <i class="fas fa-fish"></i>
                </div>
                <div class="fish-info">
                    <div class="fish-name">${log.message || '钓鱼记录'}</div>
                    <div class="fish-details">
                        时间: ${new Date(log.timestamp).toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = historyHtml;
    }
    
    async checkCooldownStatus() {
        const now = Date.now();
        // 防抖：如果距离上次检查不到5秒，跳过
        if (now - this.lastCooldownCheck < this.cooldownCheckThrottle) {
            return;
        }
        
        try {
            const response = await gameApp.apiCall('/fishing/cooldown', 'GET');
            if (response.success) {
                const data = response.data;
                if (data.is_on_cooldown) {
                    this.startCooldown(data.remaining_seconds);
                } else {
                    this.clearCooldown();
                }
                this.lastCooldownCheck = now;
            }
        } catch (error) {
            console.error('Failed to check cooldown status:', error);
        }
    }
    
    // 只在用户尝试钓鱼时检查冷却状态
    async checkCooldownBeforeFishing() {
        try {
            const response = await gameApp.apiCall('/fishing/cooldown', 'GET');
            if (response.success) {
                const data = response.data;
                if (data.is_on_cooldown) {
                    this.startCooldown(data.remaining_seconds);
                    return false; // 仍在冷却中
                } else {
                    this.clearCooldown();
                    return true; // 可以钓鱼
                }
            }
        } catch (error) {
            console.error('Failed to check cooldown status:', error);
        }
        return true; // 出错时允许钓鱼
    }
    
    async goFishing() {
        if (this.isFishing) return;
        
        // 检查是否在冷却中
        const fishingBtn = document.querySelector('button[onclick="goFishing()"]');
        if (fishingBtn && fishingBtn.disabled) return;
        
        // 在钓鱼前检查冷却状态
        const canFish = await this.checkCooldownBeforeFishing();
        if (!canFish) {
            return; // 仍在冷却中，不执行钓鱼
        }
        
        try {
            this.isFishing = true;
            showLoading(true);
            this.updateFishingButton(true);
            
            const response = await gameApp.apiCall('/fishing/cast', 'POST');
            
            if (response.success) {
                const fish = response.data.fish;
                const message = response.data.message;
                
                // 显示钓鱼结果
                this.showFishingResult(fish, message);
                
                // 刷新用户信息
                await this.loadUserInfo();
                
                // 显示冷却时间
                this.startCooldown(response.data.cooldown_seconds || 180);
                
            } else {
                // 检查是否需要重定向到登录页面
                if (response.redirect && response.redirect.includes('/login')) {
                    window.location.href = response.redirect;
                    return;
                }
                
                gameApp.showToast(response.message, 'danger');
                
                // 如果是冷却中，显示冷却时间
                if (response.message.includes('等待') || response.message.includes('冷却')) {
                    this.startCooldown(response.data.cooldown_seconds || 180);
                } else {
                    // 如果不是冷却问题，恢复按钮状态
                    this.isFishing = false;
                    this.updateFishingButton(false);
                }
            }
        } catch (error) {
            gameApp.showToast('钓鱼失败，请稍后重试', 'danger');
            this.isFishing = false;
            this.updateFishingButton(false);
        } finally {
            showLoading(false);
        }
    }
    
    updateFishingButton(fishing) {
        const fishingBtn = document.querySelector('button[onclick="goFishing()"]');
        if (fishingBtn) {
            if (fishing) {
                fishingBtn.disabled = true;
                fishingBtn.innerHTML = '<i class="fas fa-fish me-2"></i>钓鱼中...';
            } else {
                fishingBtn.disabled = false;
                fishingBtn.innerHTML = '<i class="fas fa-fish me-2"></i>开始钓鱼';
            }
        }
    }
    
    startCooldown(seconds = 180) {
        const fishingBtn = document.querySelector('button[onclick="goFishing()"]');
        if (!fishingBtn) return;
        
        // 清除之前的定时器
        if (this.cooldownTimer) {
            clearTimeout(this.cooldownTimer);
        }
        
        fishingBtn.disabled = true;
        
        // 使用服务器返回的冷却时间
        let remaining = seconds;
        
        const updateCooldown = () => {
            if (remaining <= 0) {
                fishingBtn.disabled = false;
                fishingBtn.innerHTML = '<i class="fas fa-fish me-2"></i>开始钓鱼';
                this.cooldownTimer = null;
                return;
            }
            
            const minutes = Math.floor(remaining / 60);
            const secs = remaining % 60;
            const timeStr = minutes > 0 ? `${minutes}:${secs.toString().padStart(2, '0')}` : `${secs}秒`;
            fishingBtn.innerHTML = `<i class="fas fa-clock me-2"></i>冷却中 ${timeStr}`;
            
            remaining--;
            this.cooldownTimer = setTimeout(updateCooldown, 1000);
        };
        
        updateCooldown();
    }
    
    clearCooldown() {
        const fishingBtn = document.querySelector('button[onclick="goFishing()"]');
        if (!fishingBtn) return;
        
        // 清除定时器
        if (this.cooldownTimer) {
            clearTimeout(this.cooldownTimer);
            this.cooldownTimer = null;
        }
        
        // 恢复按钮状态
        fishingBtn.disabled = false;
        fishingBtn.innerHTML = '<i class="fas fa-fish me-2"></i>开始钓鱼';
    }
    
    showFishingResult(fish, message) {
        if (fish) {
            const resultHtml = `
                <div class="fishing-result text-center">
                    <div class="fish-icon bg-${this.getRarityColor(fish.rarity)} text-white mb-3">
                        <i class="fas fa-fish"></i>
                    </div>
                    <h4 class="fish-name">${fish.name}</h4>
                    <div class="fish-details mb-2">
                        <span class="star-rating">${'★'.repeat(fish.rarity)}</span>
                        <span class="ms-2">重量: ${fish.weight}克</span>
                    </div>
                    <div class="fish-value">价值: ${fish.value} 金币</div>
                </div>
            `;
            
            // 显示结果模态框
            this.showModal('钓鱼结果', resultHtml);
        } else {
            gameApp.showToast(message, 'info');
        }
    }
    
    getRarityColor(rarity) {
        const colors = {
            1: 'secondary',
            2: 'success',
            3: 'primary',
            4: 'info',
            5: 'warning',
            6: 'dark',
            7: 'danger',
            8: 'warning',
            9: 'info',
            10: 'danger'
        };
        return colors[rarity] || 'secondary';
    }
    
    showModal(title, content) {
        const modalHtml = `
            <div class="modal fade" id="resultModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        modal.show();
        
        document.getElementById('resultModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('resultModal').remove();
        });
    }
    
    showCooldown() {
        const cooldownSection = document.getElementById('cooldownSection');
        cooldownSection.style.display = 'block';
        
        // 模拟冷却时间（实际应该从服务器获取）
        let remaining = 180; // 3分钟
        const cooldownTime = document.getElementById('cooldownTime');
        
        const updateCooldown = () => {
            cooldownTime.textContent = gameApp.formatTime(remaining);
            remaining--;
            
            if (remaining < 0) {
                cooldownSection.style.display = 'none';
                return;
            }
            
            setTimeout(updateCooldown, 1000);
        };
        
        updateCooldown();
    }
    
    async signIn() {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/user/sign-in', 'POST');
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadUserInfo();
            } else {
                gameApp.showToast(response.data.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('签到失败，请稍后重试', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async toggleAutoFishing() {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/fishing/toggle-auto', 'POST');
            
            if (response.success) {
                gameApp.showToast(response.data.message, 'success');
                await this.loadUserInfo();
            } else {
                // 检查是否需要重定向到登录页面
                if (response.redirect && response.redirect.includes('/login')) {
                    window.location.href = response.redirect;
                    return;
                }
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('操作失败，请稍后重试', 'danger');
        } finally {
            showLoading(false);
        }
    }
    
    async switchZone() {
        try {
            // 加载区域列表
            await this.loadZones();
            // 渲染区域列表
            this.renderZoneList();
            // 显示区域选择模态框
            const modal = new bootstrap.Modal(document.getElementById('zoneSelectModal'));
            modal.show();
        } catch (error) {
            gameApp.showToast('切换区域失败，请稍后重试', 'danger');
        }
    }
    
    async loadZones() {
        try {
            const response = await gameApp.apiCall('/zones', 'GET');
            if (response.success) {
                this.zones = response.data;
            }
        } catch (error) {
            console.error('Failed to load zones:', error);
        }
    }
    
    renderZoneList() {
        const container = document.getElementById('zoneList');
        
        if (this.zones.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-map fa-2x mb-2"></i>
                    <p>暂无可用区域</p>
                </div>
            `;
            return;
        }
        
        const zonesHtml = this.zones.map(zone => {
            const quota = zone.daily_rare_fish_quota || 0;
            const caught = zone.rare_fish_caught_today || 0;
            const remaining = Math.max(0, quota - caught);
            const rareHtml = quota === 0
                ? '<div class="zone-requirements text-muted">无稀有鱼</div>'
                : remaining > 0
                    ? `<div class="zone-requirements" style="color: var(--success-color)">剩余稀有鱼：${remaining} 条</div>`
                    : '<div class="zone-requirements text-muted">今日稀有鱼已捕完</div>';
            return `
            <div class="col-md-6">
                <div class="zone-card ${zone.id === this.userInfo?.fishing_zone_id ? 'selected' : ''}" 
                     onclick="selectZone(${zone.id})">
                    <div class="zone-name">${zone.name}</div>
                    <div class="zone-description">${zone.description || '暂无描述'}</div>
                    <div class="zone-cost">
                        <i class="fas fa-coins text-warning me-1"></i>
                        ${gameApp.formatNumber(zone.fishing_cost || 10)} 金币/次
                    </div>
                    ${zone.requires_pass ? '<div class="zone-requirements">需要通行证</div>' : ''}
                    ${rareHtml}
                </div>
            </div>
        `}).join('');
        
        container.innerHTML = zonesHtml;
    }
    
    async selectZone(zoneId) {
        try {
            showLoading(true);
            const response = await gameApp.apiCall('/zones/switch', 'POST', { zone_id: zoneId });
            
            if (response.success) {
                gameApp.showToast('区域切换成功', 'success');
                await this.loadUserInfo();
                bootstrap.Modal.getInstance(document.getElementById('zoneSelectModal')).hide();
            } else {
                gameApp.showToast(response.message, 'danger');
            }
        } catch (error) {
            gameApp.showToast('切换区域失败，请稍后重试', 'danger');
        } finally {
            showLoading(false);
        }
    }
}

// 全局函数
function goFishing() {
    if (window.gameHome) {
        window.gameHome.goFishing();
    }
}

function signIn() {
    if (window.gameHome) {
        window.gameHome.signIn();
    }
}

function toggleAutoFishing() {
    if (window.gameHome) {
        window.gameHome.toggleAutoFishing();
    }
}

function switchZone() {
    if (window.gameHome) {
        window.gameHome.switchZone();
    }
}

function refreshUserInfo() {
    if (window.gameHome) {
        window.gameHome.loadUserInfo();
    }
}

function selectZone(zoneId) {
    if (window.gameHome) {
        window.gameHome.selectZone(zoneId);
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    window.gameHome = new GameHome();
});
</script>
{% endblock %}
