{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <a href="{{ url_for('admin_bp.manage_shops') }}" class="btn btn-outline-secondary mb-2"><i class="fas fa-arrow-left"></i> è¿”å›å•†åº—åˆ—è¡¨</a>
        <h2><i class="fas fa-shopping-cart"></i> {{ shop.name }} - å•†å“ç®¡ç†</h2>
    </div>
    <div>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal" id="addItemBtn">
            <i class="fas fa-plus"></i> æ·»åŠ å•†å“
        </button>
    </div>
</div>

<div class="card border-primary">
    <div class="card-header">"{{ shop.name }}"ä¸­çš„å•†å“åˆ—è¡¨</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>å•†å“ID</th>
                        <th>å•†å“åç§°</th>
                        <th>æ¶ˆè€— (AND/OR)</th>
                        <th>å¥–åŠ±</th>
                        <th>åº“å­˜</th>
                        <th>é™è´­</th>
                        <th>çŠ¶æ€</th>
                        <th class="text-end">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.item.item_id }}</td>
                        <td>
                            {{ item.item.name }}
                            {% if item.rewards and item.rewards[0].rarity %}
                                <span class="text-warning">{{ 'â˜…' * item.rewards[0].rarity }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% for cost in item.costs %}
                                <span class="badge bg-info me-1">
                                    {% if cost.cost_type == 'coins' %}
                                        ğŸ’° é‡‘å¸ x{{ cost.cost_amount }}
                                    {% elif cost.cost_type == 'premium' %}
                                        ğŸ’ é«˜çº§è´§å¸ x{{ cost.cost_amount }}
                                    {% elif cost.cost_type == 'fish' %}
                                        ğŸŸ {{ cost.fish_name or ('é±¼ç±»#' + cost.cost_item_id|string) }}{% if cost.quality_level == 1 %} âœ¨é«˜å“è´¨{% endif %} x{{ cost.cost_amount }}
                                    {% elif cost.cost_type == 'item' %}
                                        ğŸ {{ cost.item_name or ('é“å…·#' + cost.cost_item_id|string) }} x{{ cost.cost_amount }}
                                    {% elif cost.cost_type == 'rod' %}
                                        ğŸ£ {{ cost.rod_name or ('é±¼ç«¿#' + cost.cost_item_id|string) }} x{{ cost.cost_amount }}
                                    {% elif cost.cost_type == 'accessory' %}
                                        ğŸ’ {{ cost.accessory_name or ('é¥°å“#' + cost.cost_item_id|string) }} x{{ cost.cost_amount }}
                                    {% else %}
                                        {{ cost.cost_type }} x{{ cost.cost_amount }}
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </td>
                        <td>
                            {% for reward in item.rewards %}
                                <span class="badge bg-success me-1">
                                    {% if reward.reward_type == 'rod' %}
                                        ğŸ£ {{ reward.rod_name or ('é±¼ç«¿#' + reward.reward_item_id|string) }} x{{ reward.reward_quantity }}
                                    {% elif reward.reward_type == 'bait' %}
                                        ğŸª± {{ reward.bait_name or ('é±¼é¥µ#' + reward.reward_item_id|string) }} x{{ reward.reward_quantity }}
                                    {% elif reward.reward_type == 'accessory' %}
                                        ğŸ’ {{ reward.accessory_name or ('é¥°å“#' + reward.reward_item_id|string) }} x{{ reward.reward_quantity }}
                                    {% elif reward.reward_type == 'item' %}
                                        ğŸ {{ reward.item_name or ('é“å…·#' + reward.reward_item_id|string) }} x{{ reward.reward_quantity }}
                                    {% elif reward.reward_type == 'fish' %}
                                        ğŸŸ {{ reward.fish_name or ('é±¼ç±»#' + reward.reward_item_id|string) }}{% if reward.quality_level == 1 %} âœ¨é«˜å“è´¨{% endif %} x{{ reward.reward_quantity }}
                                    {% elif reward.reward_type == 'coins' %}
                                        ğŸ’° é‡‘å¸ x{{ reward.reward_quantity }}
                                    {% else %}
                                        {{ reward.reward_type }} x{{ reward.reward_quantity }}
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if item.item.stock_total %}
                                {{ item.item.stock_sold or 0 }}/{{ item.item.stock_total }}
                            {% else %}
                                æ— é™
                            {% endif %}
                        </td>
                        <td>
                            {% if item.item.per_user_limit or item.item.per_user_daily_limit %}
                                {% if item.item.per_user_limit %}æ€»:{{ item.item.per_user_limit }}{% endif %}
                                {% if item.item.per_user_daily_limit %} æ—¥:{{ item.item.per_user_daily_limit }}{% endif %}
                            {% else %}
                                æ— é™åˆ¶
                            {% endif %}
                        </td>
                        <td>
                            {% if item.item.is_active %}
                                <span class="badge bg-success">å¯ç”¨</span>
                            {% else %}
                                <span class="badge bg-secondary">ç¦ç”¨</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-info edit-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addItemModal"
                                    data-item-json='{{ item|tojson|safe }}'>
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                            <form action="{{ url_for('admin_bp.remove_shop_item', item_id=item.item.item_id, shop_id=shop.shop_id) }}" method="post" class="d-inline" onsubmit="return confirm('ç¡®å®šè¦ä»å•†åº—ä¸­ç§»é™¤ã€{{ item.item.name }}ã€‘å—ï¼Ÿ');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> ç§»é™¤
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æ·»åŠ å•†å“åˆ°å•†åº—æ¨¡æ€æ¡† -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="item-form" method="post">
                <input type="hidden" name="item_id" id="item_id">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalLabel">æ·»åŠ å•†å“åˆ°å•†åº—</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å•†å“åç§° *</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å•†å“æè¿°</label>
                                <input type="text" name="description" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¥–åŠ±è®¾ç½® -->
                    <div class="mb-3">
                        <label class="form-label">å¥–åŠ±è®¾ç½®</label>
                        <div id="rewards-list">
                            <div class="row g-2 mb-2">
                                <div class="col-12 col-lg-6">
                                    <select name="reward_item_full_id" class="form-select">
                                        <option value="">-- è¯·é€‰æ‹©å¥–åŠ± --</option>
                                        <optgroup label="é±¼ç«¿">
                                            {% for rod in all_rods %}<option value="rod-{{ rod.rod_id }}" data-cost="{{ rod.purchase_cost or 0 }}" data-name="{{ rod.name }}" data-desc="{{ rod.description or '' }}">{{ rod.name }} {{ 'â˜…' * rod.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é±¼é¥µ">
                                            {% for bait in all_baits %}<option value="bait-{{ bait.bait_id }}" data-cost="{{ bait.cost or 0 }}" data-name="{{ bait.name }}" data-desc="{{ bait.description or '' }}">{{ bait.name }} {{ 'â˜…' * bait.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é¥°å“">
                                            {% for accessory in all_accessories %}<option value="accessory-{{ accessory.accessory_id }}" data-cost="{{ accessory.cost or 0 }}" data-name="{{ accessory.name }}" data-desc="{{ accessory.description or '' }}">{{ accessory.name }} {{ 'â˜…' * accessory.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é“å…·">
                                            {% for item in all_items %}<option value="item-{{ item.item_id }}" data-cost="{{ item.cost or 0 }}" data-name="{{ item.name }}" data-desc="{{ item.description or '' }}">{{ item.name }} {{ 'â˜…' * item.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é±¼ç±»">
                                            {% for fish in all_fish %}<option value="fish-{{ fish.fish_id }}" data-cost="{{ fish.base_value or 0 }}" data-name="{{ fish.name }}" data-desc="{{ fish.description or '' }}">{{ fish.name }} {{ 'â˜…' * fish.rarity }}</option>{% endfor %}
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-6 col-lg-2">
                                    <input name="reward_quantity" type="number" min="1" step="1" class="form-control" placeholder="æ•°é‡" value="1">
                                </div>
                                <div class="col-6 col-lg-2" id="rewardQualityDiv" style="display: none;">
                                    <select name="reward_quality_level" class="form-select">
                                        <option value="0">æ™®é€šå“è´¨</option>
                                        <option value="1">é«˜å“è´¨</option>
                                    </select>
                                </div>
                                <div class="col-6 col-lg-2 d-flex justify-content-center align-items-center">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-reward">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="add-reward">æ·»åŠ å¥–åŠ±</button>
                    </div>
                    
                    <!-- æ¶ˆè€—è®¾ç½® -->
                    <div class="mb-3">
                        <label class="form-label">æ¶ˆè€—è®¾ç½®</label>
                        <div id="costs-list">
                            <div class="row g-2 mb-2">
                                <div class="col-12 col-lg-4">
                                    <select name="cost_item_full_id" class="form-select">
                                        <option value="">-- è¯·é€‰æ‹©æ¶ˆè€— --</option>
                                        <optgroup label="è´§å¸">
                                            <option value="coins-0">é‡‘å¸</option>
                                            <option value="premium-0">é«˜çº§è´§å¸</option>
                                        </optgroup>
                                        <optgroup label="é±¼ç±»">
                                            {% for fish in all_fish %}<option value="fish-{{ fish.fish_id }}">{{ fish.name }} {{ 'â˜…' * fish.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é±¼ç«¿">
                                            {% for rod in all_rods %}<option value="rod-{{ rod.rod_id }}">{{ rod.name }} {{ 'â˜…' * rod.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é¥°å“">
                                            {% for accessory in all_accessories %}<option value="accessory-{{ accessory.accessory_id }}">{{ accessory.name }} {{ 'â˜…' * accessory.rarity }}</option>{% endfor %}
                                        </optgroup>
                                        <optgroup label="é“å…·">
                                            {% for item in all_items %}<option value="item-{{ item.item_id }}">{{ item.name }} {{ 'â˜…' * item.rarity }}</option>{% endfor %}
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-6 col-lg-2">
                                    <input name="cost_amount" type="number" min="1" step="1" class="form-control" placeholder="æ•°é‡" value="1">
                                </div>
                                <div class="col-6 col-lg-2" id="costQualityDiv" style="display: none;">
                                    <select name="cost_quality_level" class="form-select">
                                        <option value="0">æ™®é€šå“è´¨</option>
                                        <option value="1">é«˜å“è´¨</option>
                                    </select>
                                </div>
                                <div class="col-4 col-lg-1">
                                    <select name="cost_relation" class="form-select">
                                        <option value="and">AND</option>
                                        <option value="or">OR</option>
                                    </select>
                                </div>
                                <div class="col-4 col-lg-2">
                                    <input name="cost_group" type="number" min="1" step="1" class="form-control" placeholder="ç»„ID" title="åˆ†ç»„IDä½¿ç”¨è¯´æ˜ï¼š

åŸºæœ¬è§„åˆ™ï¼š
â€¢ ç›¸åŒç»„ID + ORå…³ç³» = å¤šé€‰ä¸€ï¼ˆç”¨æˆ·åªéœ€æ»¡è¶³å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼‰
â€¢ ä¸åŒç»„ID = å¿…é¡»åŒæ—¶æ»¡è¶³ï¼ˆANDå…³ç³»ï¼‰
â€¢ ANDå…³ç³» = å¿…é¡»æä¾›ï¼ˆæ— è®ºç»„IDå¦‚ä½•ï¼‰

é…ç½®ç¤ºä¾‹ï¼š
1. é«˜çº§è´§å¸ OR åˆ›ä¸–ç¥é³ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, OR, ç»„ID=1
   - è¡Œ2: åˆ›ä¸–ç¥é³x1, OR, ç»„ID=1

2. é«˜çº§è´§å¸ AND åˆ›ä¸–ç¥é³ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, AND, ç»„ID=1
   - è¡Œ2: åˆ›ä¸–ç¥é³x1, AND, ç»„ID=2

3. å¤æ‚ç»„åˆï¼š(é«˜çº§è´§å¸ OR é‡‘å¸) AND (åˆ›ä¸–ç¥é³ OR ä¸–ç•Œä¹‹é±¼)ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, OR, ç»„ID=1
   - è¡Œ2: é‡‘å¸x1000, OR, ç»„ID=1
   - è¡Œ3: åˆ›ä¸–ç¥é³x1, OR, ç»„ID=2
   - è¡Œ4: ä¸–ç•Œä¹‹é±¼x1, OR, ç»„ID=2">
            </div>
                                <div class="col-4 col-lg-1 d-flex justify-content-center align-items-center">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-cost">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="add-cost">æ·»åŠ æ¶ˆè€—</button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å•†åº—åº“å­˜</label>
                                <input type="number" name="stock_total" class="form-control" placeholder="ç•™ç©ºè¡¨ç¤ºæ— é™">
                                <div class="form-text">è¯¥å•†åº—å†…æ­¤å•†å“çš„ç‹¬ç«‹åº“å­˜</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å·²å”®æ•°é‡</label>
                                <input type="number" name="stock_sold" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">æ¯ç”¨æˆ·æ€»é™è´­</label>
                                <input type="number" name="per_user_limit" class="form-control" placeholder="ç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">æ¯ç”¨æˆ·æ¯æ—¥é™è´­</label>
                                <input type="number" name="per_user_daily_limit" class="form-control" placeholder="ç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">å¼€å§‹æ—¶é—´</label>
                                <input type="datetime-local" name="start_time" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ç»“æŸæ—¶é—´</label>
                                <input type="datetime-local" name="end_time" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                            <label class="form-check-label" for="isActive">åœ¨å•†åº—ä¸­å¯ç”¨</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // æ·»åŠ å•†å“åˆ°å•†åº—æ¨¡æ€æ¡†
    const addItemModal = document.getElementById('addItemModal');
    const addItemModalTitle = addItemModal.querySelector('.modal-title');
    const addItemForm = addItemModal.querySelector('#item-form');
    const addItemBtn = document.getElementById('addItemBtn');
    const editItemBtns = document.querySelectorAll('.edit-btn');

    if(addItemBtn) {
        addItemBtn.addEventListener('click', function () {
            addItemModalTitle.textContent = 'æ·»åŠ å•†å“åˆ°å•†åº—';
            addItemForm.action = "{{ url_for('admin_bp.add_shop_item', shop_id=shop.shop_id) }}";
            addItemForm.reset();
            if (addItemForm.elements['is_active']) addItemForm.elements['is_active'].checked = true;
        });
    }

    if(editItemBtns) {
        editItemBtns.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const data = JSON.parse(this.dataset.itemJson);
                addItemModalTitle.textContent = `ç¼–è¾‘å•†å“: ${data.item.name}`;
                addItemForm.action = `/admin/shops/{{ shop.shop_id }}/items/edit/${data.item.item_id}`;

                // å¡«å……è¡¨å•
                if (addItemForm.elements['name']) {
                    addItemForm.elements['name'].value = data.item.name || '';
                }
                if (addItemForm.elements['description']) {
                    addItemForm.elements['description'].value = data.item.description || '';
                }
                if (addItemForm.elements['item_id']) addItemForm.elements['item_id'].value = data.item.item_id;
                if (addItemForm.elements['stock_total']) addItemForm.elements['stock_total'].value = data.item.stock_total || '';
                if (addItemForm.elements['stock_sold']) addItemForm.elements['stock_sold'].value = data.item.stock_sold || 0;
                if (addItemForm.elements['per_user_limit']) addItemForm.elements['per_user_limit'].value = data.item.per_user_limit || '';
                if (addItemForm.elements['per_user_daily_limit']) addItemForm.elements['per_user_daily_limit'].value = data.item.per_user_daily_limit || '';
                if (addItemForm.elements['is_active']) addItemForm.elements['is_active'].checked = !!data.item.is_active;
                
                // æ—¶é—´å­—æ®µ
                if (addItemForm.elements['start_time']) {
                    if (data.item.start_time) {
                        // è½¬æ¢ä¸º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:MM)
                        addItemForm.elements['start_time'].value = data.item.start_time.replace(' ', 'T').substring(0, 16);
                    } else {
                        addItemForm.elements['start_time'].value = '';
                    }
                }
                if (addItemForm.elements['end_time']) {
                    if (data.item.end_time) {
                        // è½¬æ¢ä¸º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:MM)
                        addItemForm.elements['end_time'].value = data.item.end_time.replace(' ', 'T').substring(0, 16);
                    } else {
                        addItemForm.elements['end_time'].value = '';
                    }
                }
                
                // å¡«å……æ¶ˆè€—æ•°æ®
                const costsList = document.getElementById('costs-list');
                if (costsList && data.costs) {
                    // ä¿ç•™ç¬¬ä¸€è¡Œç”¨äºè‡ªåŠ¨å¡«å……ï¼Œæ¸…ç©ºå…¶ä»–è¡Œ
                    const existingRows = costsList.querySelectorAll('.row.g-2.mb-2');
                    existingRows.forEach((row, index) => {
                        if (index > 0) { // ä¿ç•™ç¬¬ä¸€è¡Œ
                            row.remove();
                        }
                    });
                    
                    // æ¸…ç©ºç¬¬ä¸€è¡Œçš„å€¼
                    const firstRow = costsList.querySelector('.row.g-2.mb-2');
                    if (firstRow) {
                        const firstSelect = firstRow.querySelector('select[name="cost_item_full_id"]');
                        const firstAmount = firstRow.querySelector('input[name="cost_amount"]');
                        if (firstSelect) firstSelect.value = '';
                        if (firstAmount) firstAmount.value = '';
                    }
                    
                    // æ·»åŠ æ¶ˆè€—è¡Œ
                    data.costs.forEach(cost => {
                        addCostRow();
                        const lastRow = costsList.lastElementChild;
                        const select = lastRow.querySelector('select[name="cost_item_full_id"]');
                        const amountInput = lastRow.querySelector('input[name="cost_amount"]');
                        const relationSelect = lastRow.querySelector('select[name="cost_relation"]');
                        const groupInput = lastRow.querySelector('input[name="cost_group"]');
                        
                        if (cost.cost_type === 'coins') {
                            select.value = 'coins-0';
                        } else if (cost.cost_type === 'premium') {
                            select.value = 'premium-0';
                        } else if (cost.cost_type === 'fish') {
                            select.value = `fish-${cost.cost_item_id}`;
                        } else if (cost.cost_type === 'item') {
                            select.value = `item-${cost.cost_item_id}`;
                        }
                        
                        if (amountInput) {
                            amountInput.value = cost.cost_amount;
                        }
                        if (relationSelect) {
                            relationSelect.value = cost.cost_relation || 'and';
                        }
                        if (groupInput && cost.group_id) {
                            groupInput.value = cost.group_id;
                        }
                        
                        // è®¾ç½®å“è´¨ç­‰çº§å¹¶è§¦å‘æ˜¾ç¤º/éšè—
                        const qualitySelect = lastRow.querySelector('select[name="cost_quality_level"]');
                        if (qualitySelect) {
                            qualitySelect.value = cost.quality_level || 0;
                        }
                        const qualityDiv = lastRow.querySelector('#costQualityDiv');
                        if (qualityDiv) {
                            qualityDiv.style.display = cost.cost_type === 'fish' ? 'block' : 'none';
                        }
                    });
                }
                
                // å¡«å……å¥–åŠ±æ•°æ®
                const rewardsList = document.getElementById('rewards-list');
                if (rewardsList && data.rewards) {
                    // ä¿ç•™ç¬¬ä¸€è¡Œç”¨äºè‡ªåŠ¨å¡«å……ï¼Œæ¸…ç©ºå…¶ä»–è¡Œ
                    const existingRows = rewardsList.querySelectorAll('.row.g-2.mb-2');
                    existingRows.forEach((row, index) => {
                        if (index > 0) { // ä¿ç•™ç¬¬ä¸€è¡Œ
                            row.remove();
                        }
                    });
                    
                    // æ¸…ç©ºç¬¬ä¸€è¡Œçš„å€¼
                    const firstRow = rewardsList.querySelector('.row.g-2.mb-2');
                    if (firstRow) {
                        const firstSelect = firstRow.querySelector('select[name="reward_item_full_id"]');
                        const firstQuantity = firstRow.querySelector('input[name="reward_quantity"]');
                        const firstRefine = firstRow.querySelector('input[name="reward_refine_level"]');
                        if (firstSelect) firstSelect.value = '';
                        if (firstQuantity) firstQuantity.value = '1';
                        if (firstRefine) firstRefine.value = '';
                    }
                    
                    // æ·»åŠ å¥–åŠ±è¡Œ
                    data.rewards.forEach(reward => {
                        addRewardRow();
                        const lastRow = rewardsList.lastElementChild;
                        const select = lastRow.querySelector('select[name="reward_item_full_id"]');
                        const quantityInput = lastRow.querySelector('input[name="reward_quantity"]');
                        const refineInput = lastRow.querySelector('input[name="reward_refine_level"]');
                        
                        if (reward.reward_type === 'rod') {
                            select.value = `rod-${reward.reward_item_id}`;
                        } else if (reward.reward_type === 'bait') {
                            select.value = `bait-${reward.reward_item_id}`;
                        } else if (reward.reward_type === 'accessory') {
                            select.value = `accessory-${reward.reward_item_id}`;
                        } else if (reward.reward_type === 'item') {
                            select.value = `item-${reward.reward_item_id}`;
                        } else if (reward.reward_type === 'fish') {
                            select.value = `fish-${reward.reward_item_id}`;
                        } else if (reward.reward_type === 'coins') {
                            select.value = 'coins-0';
                        }
                        
                        if (quantityInput) {
                            quantityInput.value = reward.reward_quantity;
                        }
                        if (refineInput && reward.reward_refine_level) {
                            refineInput.value = reward.reward_refine_level;
                        }
                        
                        // è®¾ç½®å“è´¨ç­‰çº§å¹¶è§¦å‘æ˜¾ç¤º/éšè—
                        const qualitySelect = lastRow.querySelector('select[name="reward_quality_level"]');
                        if (qualitySelect) {
                            qualitySelect.value = reward.quality_level || 0;
                        }
                        const qualityDiv = lastRow.querySelector('#rewardQualityDiv');
                        if (qualityDiv) {
                            qualityDiv.style.display = reward.reward_type === 'fish' ? 'block' : 'none';
                        }
                    });
                }
                
                // é‡æ–°è®¾ç½®å“è´¨é€‰æ‹©åŠŸèƒ½ï¼ˆå› ä¸ºæ–°æ·»åŠ çš„è¡Œéœ€è¦é‡æ–°ç»‘å®šäº‹ä»¶ï¼‰
                setupCostQualityToggle();
                setupRewardQualityToggle();
                
                // æ˜¾ç¤º Modal
                try {
                    const modal = bootstrap.Modal.getOrCreateInstance(addItemModal);
                    modal.show();
                } catch (error) {
                    console.error('Modal åˆå§‹åŒ–å¤±è´¥:', error);
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†
                    addItemModal.style.display = 'block';
                    addItemModal.classList.add('show');
                    document.body.classList.add('modal-open');
                }
            });
        });
    }



    // åŠ¨æ€æ·»åŠ æ¶ˆè€—å’Œå¥–åŠ±è¡Œ
    document.getElementById('add-cost')?.addEventListener('click', addCostRow);
    document.getElementById('add-reward')?.addEventListener('click', addRewardRow);

    // è‡ªåŠ¨å¡«å……å•†å“åç§°/æè¿°ä¸é‡‘å¸æˆæœ¬ - ç®€åŒ–ç‰ˆä½†å®ç”¨
    function setupAutoFill() {
        const nameInput = document.querySelector('input[name="name"]');
        const descriptionInput = document.querySelector('input[name="description"]');
        
        // ç›‘å¬ç¬¬ä¸€ä¸ªå¥–åŠ±é€‰æ‹©çš„å˜åŒ–
        const firstRewardSelect = document.querySelector('select[name="reward_item_full_id"]');
        if (firstRewardSelect) {
            firstRewardSelect.addEventListener('change', function() {
                if (!this.value) return;
                const selectedOption = this.options[this.selectedIndex];

                // 1) è‡ªåŠ¨å¡«å……åç§°ä¸æè¿°ï¼ˆä»…å½“ä¸ºç©ºï¼‰
                const itemName = selectedOption.dataset.name || selectedOption.textContent.trim();
                const itemDesc = selectedOption.dataset.desc || '';
                if (!nameInput.value && itemName) {
                    nameInput.value = itemName;
                }
                if (!descriptionInput.value && itemDesc) {
                    descriptionInput.value = itemDesc;
                }

                // 2) è‡ªåŠ¨å¡«å……é‡‘å¸æˆæœ¬åˆ°ç¬¬ä¸€ä¸ªæ¶ˆè€—è¡Œ
                const price = Number(selectedOption.dataset.cost || 0);
                if (price > 0) {
                    const firstCostSelect = document.querySelector('#costs-list select[name="cost_item_full_id"]');
                    const firstCostAmount = document.querySelector('#costs-list input[name="cost_amount"]');
                    if (firstCostSelect) firstCostSelect.value = 'coins-0';
                    if (firstCostAmount) firstCostAmount.value = String(price);
                }
            });
        }
    }

    // åˆå§‹åŒ–è‡ªåŠ¨å¡«å……
    setupAutoFill();
    
    // é€šç”¨çš„å“è´¨é€‰æ‹©æ˜¾ç¤º/éšè—åŠŸèƒ½
    function setupQualityToggle(containerSelector, itemSelector) {
        const selects = document.querySelectorAll(`${containerSelector} select[name="${itemSelector}"]`);
        selects.forEach(select => {
            // é¿å…é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (select.hasAttribute('data-quality-toggle-bound')) {
                return;
            }
            select.setAttribute('data-quality-toggle-bound', 'true');
            
            const qualityDiv = select.closest('.row').querySelector('[id$="QualityDiv"]');
            if (qualityDiv) {
                select.addEventListener('change', function() {
                    const isFish = this.value.startsWith('fish-');
                    qualityDiv.style.display = isFish ? 'block' : 'none';
                });
            }
        });
    }
    
    // ä¸ºç°æœ‰çš„æˆæœ¬é€‰æ‹©æ¡†æ·»åŠ å“è´¨é€‰æ‹©æ˜¾ç¤º/éšè—åŠŸèƒ½
    function setupCostQualityToggle() {
        setupQualityToggle('#costs-list', 'cost_item_full_id');
    }
    
    // ä¸ºç°æœ‰çš„å¥–åŠ±é€‰æ‹©æ¡†æ·»åŠ å“è´¨é€‰æ‹©æ˜¾ç¤º/éšè—åŠŸèƒ½
    function setupRewardQualityToggle() {
        setupQualityToggle('#rewards-list', 'reward_item_full_id');
    }
    
    // åˆå§‹åŒ–å“è´¨é€‰æ‹©åŠŸèƒ½
    setupCostQualityToggle();
    setupRewardQualityToggle();

    function addCostRow() {
        const container = document.getElementById('costs-list');
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2';
        row.innerHTML = `
            <div class="col-12 col-lg-4">
                <select name="cost_item_full_id" class="form-select">
                    <option value="">-- è¯·é€‰æ‹©æ¶ˆè€— --</option>
                    <optgroup label="è´§å¸">
                        <option value="coins-0">é‡‘å¸</option>
                        <option value="premium-0">é«˜çº§è´§å¸</option>
                    </optgroup>
                    <optgroup label="é±¼ç±»">
                        {% for fish in all_fish %}<option value="fish-{{ fish.fish_id }}">{{ fish.name }} {{ 'â˜…' * fish.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é±¼ç«¿">
                        {% for rod in all_rods %}<option value="rod-{{ rod.rod_id }}">{{ rod.name }} {{ 'â˜…' * rod.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é¥°å“">
                        {% for accessory in all_accessories %}<option value="accessory-{{ accessory.accessory_id }}">{{ accessory.name }} {{ 'â˜…' * accessory.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é“å…·">
                        {% for item in all_items %}<option value="item-{{ item.item_id }}">{{ item.name }} {{ 'â˜…' * item.rarity }}</option>{% endfor %}
                    </optgroup>
                </select>
            </div>
            <div class="col-6 col-lg-2">
                <input name="cost_amount" type="number" min="1" step="1" class="form-control" placeholder="æ•°é‡" value="1">
            </div>
            <div class="col-6 col-lg-2" id="costQualityDiv" style="display: none;">
                <select name="cost_quality_level" class="form-select">
                    <option value="0">æ™®é€šå“è´¨</option>
                    <option value="1">é«˜å“è´¨</option>
                </select>
            </div>
            <div class="col-4 col-lg-1">
                <select name="cost_relation" class="form-select">
                    <option value="and">AND</option>
                    <option value="or">OR</option>
                </select>
            </div>
            <div class="col-4 col-lg-2">
                <input name="cost_group" type="number" min="1" step="1" class="form-control" placeholder="ç»„ID" title="åˆ†ç»„IDä½¿ç”¨è¯´æ˜ï¼š

åŸºæœ¬è§„åˆ™ï¼š
â€¢ ç›¸åŒç»„ID + ORå…³ç³» = å¤šé€‰ä¸€ï¼ˆç”¨æˆ·åªéœ€æ»¡è¶³å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼‰
â€¢ ä¸åŒç»„ID = å¿…é¡»åŒæ—¶æ»¡è¶³ï¼ˆANDå…³ç³»ï¼‰
â€¢ ANDå…³ç³» = å¿…é¡»æä¾›ï¼ˆæ— è®ºç»„IDå¦‚ä½•ï¼‰

é…ç½®ç¤ºä¾‹ï¼š
1. é«˜çº§è´§å¸ OR åˆ›ä¸–ç¥é³ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, OR, ç»„ID=1
   - è¡Œ2: åˆ›ä¸–ç¥é³x1, OR, ç»„ID=1

2. é«˜çº§è´§å¸ AND åˆ›ä¸–ç¥é³ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, AND, ç»„ID=1
   - è¡Œ2: åˆ›ä¸–ç¥é³x1, AND, ç»„ID=2

3. å¤æ‚ç»„åˆï¼š(é«˜çº§è´§å¸ OR é‡‘å¸) AND (åˆ›ä¸–ç¥é³ OR ä¸–ç•Œä¹‹é±¼)ï¼š
   - è¡Œ1: é«˜çº§è´§å¸x10, OR, ç»„ID=1
   - è¡Œ2: é‡‘å¸x1000, OR, ç»„ID=1
   - è¡Œ3: åˆ›ä¸–ç¥é³x1, OR, ç»„ID=2
   - è¡Œ4: ä¸–ç•Œä¹‹é±¼x1, OR, ç»„ID=2">
            </div>
            <div class="col-4 col-lg-1 d-flex justify-content-center align-items-center">
                <button type="button" class="btn btn-outline-danger btn-sm remove-cost">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(row);
        
        row.querySelector('.remove-cost').addEventListener('click', function() {
            row.remove();
        });
        
        // æ·»åŠ å“è´¨é€‰æ‹©æ˜¾ç¤º/éšè—é€»è¾‘
        setupQualityToggle('', 'cost_item_full_id');
        
    }

    function addRewardRow() {
        const container = document.getElementById('rewards-list');
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2';
        row.innerHTML = `
            <div class="col-12 col-lg-6">
                <select name="reward_item_full_id" class="form-select">
                    <option value="">-- è¯·é€‰æ‹©å¥–åŠ± --</option>
                    <optgroup label="é±¼ç«¿">
                        {% for rod in all_rods %}<option value="rod-{{ rod.rod_id }}" data-cost="{{ rod.purchase_cost or 0 }}" data-name="{{ rod.name }}" data-desc="{{ rod.description or '' }}">{{ rod.name }} {{ 'â˜…' * rod.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é±¼é¥µ">
                        {% for bait in all_baits %}<option value="bait-{{ bait.bait_id }}" data-cost="{{ bait.cost or 0 }}" data-name="{{ bait.name }}" data-desc="{{ bait.description or '' }}">{{ bait.name }} {{ 'â˜…' * bait.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é¥°å“">
                        {% for accessory in all_accessories %}<option value="accessory-{{ accessory.accessory_id }}" data-cost="{{ accessory.cost or 0 }}" data-name="{{ accessory.name }}" data-desc="{{ accessory.description or '' }}">{{ accessory.name }} {{ 'â˜…' * accessory.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é“å…·">
                        {% for item in all_items %}<option value="item-{{ item.item_id }}" data-cost="{{ item.cost or 0 }}" data-name="{{ item.name }}" data-desc="{{ item.description or '' }}">{{ item.name }} {{ 'â˜…' * item.rarity }}</option>{% endfor %}
                    </optgroup>
                    <optgroup label="é±¼ç±»">
                        {% for fish in all_fish %}<option value="fish-{{ fish.fish_id }}" data-cost="{{ fish.base_value or 0 }}" data-name="{{ fish.name }}" data-desc="{{ fish.description or '' }}">{{ fish.name }} {{ 'â˜…' * fish.rarity }}</option>{% endfor %}
                    </optgroup>
                </select>
            </div>
            <div class="col-6 col-lg-2">
                <input name="reward_quantity" type="number" min="1" step="1" class="form-control" placeholder="æ•°é‡" value="1">
            </div>
            <div class="col-6 col-lg-2" id="rewardQualityDiv" style="display: none;">
                <select name="reward_quality_level" class="form-select">
                    <option value="0">æ™®é€šå“è´¨</option>
                    <option value="1">é«˜å“è´¨</option>
                </select>
            </div>
            <div class="col-6 col-lg-2 d-flex justify-content-center align-items-center">
                <button type="button" class="btn btn-outline-danger btn-sm remove-reward">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(row);
        
        row.querySelector('.remove-reward').addEventListener('click', function() {
            row.remove();
        });
        
        // æ·»åŠ å“è´¨é€‰æ‹©æ˜¾ç¤º/éšè—é€»è¾‘
        setupQualityToggle('', 'reward_item_full_id');
    }
});
</script>
{% endblock %}
