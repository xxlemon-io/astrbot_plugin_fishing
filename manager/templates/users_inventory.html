{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-boxes"></i> ç”¨æˆ·ç‰©å“ç®¡ç† - {{ user_nickname }}</h2>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="fas fa-plus"></i> æ·»åŠ ç‰©å“
        </button>
        <a href="{{ url_for('admin_bp.manage_users') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> è¿”å›ç”¨æˆ·åˆ—è¡¨
        </a>
    </div>
</div>

<!-- åº“å­˜ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-lg col-md-4 col-6 mb-3 mb-lg-0">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ inventory.stats.fish_count }}</h4>
                        <p class="card-text">é±¼ç±»</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-water fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg col-md-4 col-6 mb-3 mb-lg-0">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ inventory.stats.rod_count }}</h4>
                        <p class="card-text">é±¼ç«¿</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-gavel fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg col-md-4 col-6 mb-3 mb-lg-0">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ inventory.stats.accessory_count }}</h4>
                        <p class="card-text">é¥°å“</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-gem fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg col-md-4 col-6 mb-3 mb-lg-0">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ inventory.stats.bait_count }}</h4>
                        <p class="card-text">é±¼é¥µ</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bug fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg col-md-4 col-6 mb-3 mb-lg-0">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ inventory.stats.item_count }}</h4>
                        <p class="card-text">é“å…·</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-toolbox fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ€»ä»·å€¼æ˜¾ç¤º -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-body text-center">
                <h5 class="card-title text-success">
                    <i class="fas fa-coins"></i> åº“å­˜æ€»ä»·å€¼: {{ inventory.stats.total_inventory_value }} é‡‘å¸
                </h5>
                <p class="card-text">
                    é±¼ç±»ä»·å€¼: {{ inventory.stats.fish_total_value }} é‡‘å¸ | 
                    é±¼é¥µä»·å€¼: {{ inventory.stats.bait_total_value }} é‡‘å¸ |
                    é“å…·ä»·å€¼: {{ inventory.stats.item_total_value }} é‡‘å¸
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ç‰©å“åˆ†ç±»æ ‡ç­¾é¡µ -->
<ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="fish-tab" data-bs-toggle="tab" data-bs-target="#fish" type="button" role="tab">
            <i class="fas fa-water"></i> é±¼ç±» ({{ inventory.stats.fish_count }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="rods-tab" data-bs-toggle="tab" data-bs-target="#rods" type="button" role="tab">
            <i class="fas fa-gavel"></i> é±¼ç«¿ ({{ inventory.stats.rod_count }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="accessories-tab" data-bs-toggle="tab" data-bs-target="#accessories" type="button" role="tab">
            <i class="fas fa-gem"></i> é¥°å“ ({{ inventory.stats.accessory_count }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="baits-tab" data-bs-toggle="tab" data-bs-target="#baits" type="button" role="tab">
            <i class="fas fa-bug"></i> é±¼é¥µ ({{ inventory.stats.bait_count }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            <i class="fas fa-toolbox"></i> é“å…· ({{ inventory.stats.item_count }})
        </button>
    </li>
</ul>

<div class="tab-content" id="inventoryTabsContent">
    <!-- é±¼ç±»åº“å­˜ -->
    <div class="tab-pane fade show active" id="fish" role="tabpanel">
        <div class="card">
            <div class="card-body">
                {% if inventory.fish_inventory %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>å“è´¨</th>
                                <th>åŸºç¡€ä»·å€¼</th>
                                <th>å®é™…ä»·å€¼</th>
                                <th>æ•°é‡</th>
                                <th>æ€»ä»·å€¼</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory.fish_inventory %}
                            <tr>
                                <td>{{ item.fish_id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ 'â˜…' * item.rarity }}</td>
                                <td>
                                    {% if item.quality_level == 1 %}
                                        <span class="badge bg-warning text-dark">âœ¨ é«˜å“è´¨</span>
                                    {% else %}
                                        <span class="badge bg-secondary">æ™®é€š</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.base_value }}</td>
                                <td>
                                    {% if item.quality_level == 1 %}
                                        <span class="text-warning fw-bold">{{ item.actual_value }}</span>
                                    {% else %}
                                        {{ item.actual_value }}
                                    {% endif %}
                                </td>
                                <td>{{ item.quantity }}</td>
                                <td>
                                    {% if item.quality_level == 1 %}
                                        <span class="text-warning fw-bold">{{ item.total_value }}</span>
                                    {% else %}
                                        {{ item.total_value }}
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-danger" onclick="removeItem('fish', {{ item.fish_id }}, {{ item.quantity }}, {{ item.quality_level }})">
                                        <i class="fas fa-trash"></i> ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-water fa-3x mb-3"></i>
                    <p>è¯¥ç”¨æˆ·æ²¡æœ‰é±¼ç±»åº“å­˜</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é±¼ç«¿åº“å­˜ -->
    <div class="tab-pane fade" id="rods" role="tabpanel">
        <div class="card">
            <div class="card-body">
                {% if inventory.rod_inventory %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>å®ä¾‹ID</th>
                                <th>åç§°</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>ç²¾ç‚¼ç­‰çº§</th>
                                <th>è€ä¹…åº¦</th>
                                <th>çŠ¶æ€</th>
                                <th>é”å®š</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory.rod_inventory %}
                            <tr>
                                <td>{{ item.display_code if item.display_code else item.instance_id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ 'â˜…' * item.rarity }}</td>
                                <td>{{ item.refine_level }}</td>
                                <td>{{ item.durability if item.durability is not none else 'âˆ' }}</td>
                                <td>
                                    {% if item.is_equipped %}
                                        <span class="badge bg-success">å·²è£…å¤‡</span>
                                    {% else %}
                                        <span class="badge bg-secondary">æœªè£…å¤‡</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.is_locked %}
                                        <span class="badge bg-warning">å·²é”å®š</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">æœªé”å®š</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRodRefine({{ item.instance_id }}, {{ item.refine_level }})">
                                        <i class="fas fa-level-up-alt"></i> è®¾ç²¾ç‚¼
                                    </button>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="editRodDurability({{ item.instance_id }}, '{{ item.durability if item.durability is not none else '' }}')">
                                        <i class="fas fa-wrench"></i> è®¾è€ä¹…
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="removeItem('rod', {{ item.rod_id }}, 1)">
                                        <i class="fas fa-trash"></i> ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-gavel fa-3x mb-3"></i>
                    <p>è¯¥ç”¨æˆ·æ²¡æœ‰é±¼ç«¿åº“å­˜</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é¥°å“åº“å­˜ -->
    <div class="tab-pane fade" id="accessories" role="tabpanel">
        <div class="card">
            <div class="card-body">
                {% if inventory.accessory_inventory %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>å®ä¾‹ID</th>
                                <th>åç§°</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>ç²¾ç‚¼ç­‰çº§</th>
                                <th>çŠ¶æ€</th>
                                <th>é”å®š</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory.accessory_inventory %}
                            <tr>
                                <td>{{ item.display_code if item.display_code else item.instance_id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ 'â˜…' * item.rarity }}</td>
                                <td>{{ item.refine_level }}</td>
                                <td>
                                    {% if item.is_equipped %}
                                        <span class="badge bg-success">å·²è£…å¤‡</span>
                                    {% else %}
                                        <span class="badge bg-secondary">æœªè£…å¤‡</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.is_locked %}
                                        <span class="badge bg-warning">ğŸ”’ å·²é”å®š</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">ğŸ”“ æœªé”å®š</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editAccessoryRefine({{ item.instance_id }}, {{ item.refine_level }})">
                                        <i class="fas fa-level-up-alt"></i> è®¾ç²¾ç‚¼
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="removeItem('accessory', {{ item.accessory_id }}, 1)">
                                        <i class="fas fa-trash"></i> ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-gem fa-3x mb-3"></i>
                    <p>è¯¥ç”¨æˆ·æ²¡æœ‰é¥°å“åº“å­˜</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é±¼é¥µåº“å­˜ -->
    <div class="tab-pane fade" id="baits" role="tabpanel">
        <div class="card">
            <div class="card-body">
                {% if inventory.bait_inventory %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>å•ä»·</th>
                                <th>æ•°é‡</th>
                                <th>æ€»ä»·å€¼</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory.bait_inventory %}
                            <tr>
                                <td>{{ item.bait_id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ 'â˜…' * item.rarity }}</td>
                                <td>{{ item.cost }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.total_value }}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-danger" onclick="removeItem('bait', {{ item.bait_id }}, {{ item.quantity }})">
                                        <i class="fas fa-trash"></i> ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-bug fa-3x mb-3"></i>
                    <p>è¯¥ç”¨æˆ·æ²¡æœ‰é±¼é¥µåº“å­˜</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é“å…·åº“å­˜ -->
    <div class="tab-pane fade" id="items" role="tabpanel">
        <div class="card">
            <div class="card-body">
                {% if inventory.item_inventory %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>æ¶ˆè€—å“</th>
                                <th>å•ä»·</th>
                                <th>æ•°é‡</th>
                                <th>æ€»ä»·å€¼</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory.item_inventory %}
                            <tr>
                                <td>{{ item.item_id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ 'â˜…' * item.rarity }}</td>
                                <td>
                                    {% if item.is_consumable %}
                                        <span class="badge bg-success">æ˜¯</span>
                                    {% else %}
                                        <span class="badge bg-secondary">å¦</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.cost }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.total_value }}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-danger" onclick="removeItem('item', {{ item.item_id }}, {{ item.quantity }})">
                                        <i class="fas fa-trash"></i> ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-toolbox fa-3x mb-3"></i>
                    <p>è¯¥ç”¨æˆ·æ²¡æœ‰é“å…·åº“å­˜</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ ç‰©å“æ¨¡æ€æ¡† -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">æ·»åŠ ç‰©å“åˆ°ç”¨æˆ·åº“å­˜</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="itemType" class="form-label">ç‰©å“ç±»å‹</label>
                            <select class="form-select" id="itemType" required>
                                <option value="">é€‰æ‹©ç‰©å“ç±»å‹</option>
                                <option value="fish">é±¼ç±»</option>
                                <option value="rod">é±¼ç«¿</option>
                                <option value="accessory">é¥°å“</option>
                                <option value="bait">é±¼é¥µ</option>
                                <option value="item">é“å…·</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="itemId" class="form-label">ç‰©å“</label>
                            <select class="form-select" id="itemId" required disabled>
                                <option value="">è¯·å…ˆé€‰æ‹©ç‰©å“ç±»å‹</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quantity" class="form-label">æ•°é‡</label>
                            <input type="number" class="form-control" id="quantity" value="1" min="1" required>
                        </div>
                        <div class="col-md-6" id="qualityLevelDiv" style="display: none;">
                            <label for="qualityLevel" class="form-label">å“è´¨ç­‰çº§</label>
                            <select class="form-select" id="qualityLevel">
                                <option value="0">æ™®é€šå“è´¨</option>
                                <option value="1">é«˜å“è´¨</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addItem()">æ·»åŠ ç‰©å“</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å®šä¹‰JSéœ€è¦çš„åç«¯URLå˜é‡
    const userId = "{{ user_id }}";
    const addItemUrl = "{{ url_for('admin_bp.add_item_to_user_inventory', user_id=user_id) }}";
    const removeItemUrl = "{{ url_for('admin_bp.remove_item_from_user_inventory', user_id=user_id) }}";
    const updateRodInstanceUrlTemplate = "{{ url_for('admin_bp.update_rod_instance', user_id=user_id, instance_id=12345) }}";
    const updateAccessoryInstanceUrlTemplate = "{{ url_for('admin_bp.update_accessory_instance', user_id=user_id, instance_id=12345) }}";
    
    // ç‰©å“æ¨¡æ¿æ•°æ®
    const fishTemplates = {{ all_fish | tojson | safe }};
    const rodTemplates = {{ all_rods | tojson | safe }};
    const accessoryTemplates = {{ all_accessories | tojson | safe }};
    const baitTemplates = {{ all_baits | tojson | safe }};
    const itemsTemplates = {{ all_items | tojson | safe }};
    
    // å¼ºåˆ¶å˜é‡åˆå§‹åŒ–ï¼ˆé˜²æ­¢æ—¶åºé—®é¢˜ï¼‰
    void addItemUrl;
</script>
<script src="{{ url_for('admin_bp.static', filename='js/users_inventory_manager.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
